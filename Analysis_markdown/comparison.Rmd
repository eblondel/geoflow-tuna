---
title: 'Comparison of two data sets at different levels/options of the tuna atlas'
date: "`r format(Sys.time(), '%d %B, %Y')`"
author:
  - name: Bastien Grasset
    email: bastien.grasset@ird.fr
    affiliation:
      - IRD
      - MARBEC
  - name: Emmanuel Blondel
    affiliation: FAO
  - name: Julien Barde
    affiliation:
      - IRD
      - MARBEC
  - name: Paul Taconet 
    affiliation: IRD
address:
  - code: IRD
    address: Institut de Recherche pour le Développement (IRD), av. Jean Monnet, CS 30171, 34203 Sète cédex, France
  - code: MARBEC
    address: MARBEC, University of Montpellier, CNRS, Ifremer, IRD, Sète, France
# bibliography: ["IOTC-2022-WPDCS18.bib"] # Replace with one or more of your own bibtex files. Better BibTeX for Zotero is your friend
csl: dmk-format.csl # Use any CSL style. See https://www.zotero.org/styles for a good list. Ignored if citation_package: natbib
link-citations: TRUE
output:
  bookdown::pdf_document2:
    extra_dependencies: ["adjustbox", "subfig", "flafter"]
    toc: FALSE
    keep_tex: TRUE
    template: template.tex
    #md_extensions: "-autolink_bare_uris"
    number_sections: TRUE
    citation_package: default # Can also be "natbib"
  bookdown::word_document2: 
    # Produces largely readable output, though some cross-referencing may fail. Useful for collaboration.
    toc: TRUE
lang: en # Main document language in BCP47 format
geometry: "margin=25mm"
papersize: a4
#linestretch: 2 # for double spacing
endfloat: FALSE # Set to TRUE to turn on latex endfloat package to place figures and tables at end of document
# endfloatoption: # See endfloat documentation for more possibilities
#   - tablesfirst # Default
#   - nomarkers # Default
numberlines: FALSE
authblk: FALSE # FALSE = author affiliations in footnotes; TRUE = author affiliations in a block below author names
footnotehyper: FALSE # TRUE will give you enhanced table footnote capabilities. Set to FALSE to be able to use French blocks. Needed due to what appears to be a latex bug.
urlcolor: blue
linkcolor: blue
citecolor: blue
graphics: TRUE # Needed to be able to include images
tables: TRUE # Needed to be able to include tables
fancyhdr:
  first:
    headleft: "Global Tuna Atlas comparison between two datasets"
    headright: "GTA"
    headrulewidth: 0pt
    #footleft: A left foot
    footrulewidth: 0pt
  subsequent:
    headleft: "Global Tuna Atlas comparison between two datasets"
    headright: "GTA"
    headrulewidth: 1pt
    footrulewidth: 0pt
params: 
  init: "data/ancient"
  final: "~/Documents/Tunaatlas_level1/jobs/20230124095233_global_catch_RF3_base_new/entities/ird_level2_2/Markdown/Removing_absurd_nomt/"
  time_dimension:
  geographical_dimension:
  fact: "catch"
  colnames_to_keep: 
  columns_to_keep: [  "Precision"     ,                   "unit"      ,                     
  "Values dataset 1"      ,"Values dataset 2"      ,                               "Loss / Gain",
   "Difference (in %)"          ,     " Dimension"   ,       "Difference in value" ]
  short: FALSE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE, fig.align = 'center', error = TRUE
)
```


```{r cache=FALSE, include=FALSE}
last_path_reduced = function(x){gsub("georef_dataset","",last_path(x))}

is_null_or_not_exist <- function(x) {
  if (!exists(deparse(substitute(x))) || is.null(x)) {
    return(TRUE)
  } else {
    return(FALSE)
  }
}
base::options(scipen=999)

```


```{r include=FALSE}
if(!exists("child")){child = FALSE} else{child = child}
if(!exists("step_title")){step_title_t_f = FALSE} else{step_title_t_f = TRUE}
```

```{r include=FALSE}
if(exists("params")){
  for (i in 1:length(params)){
  if(!exists(paste0("parameter_",names(params)[i]))){
    assign(paste0("parameter_",names(params)[i]), params[i][[1]])
    }
}
}

```


<!-- ```{r include=FALSE} -->
<!-- if(!exists("fact") || is.null(fact)){fact <-  "effort"} -->
<!-- ``` -->



```{r include=FALSE}
if(!(require(dplyr))){ 
  install.packages("dplyr") 
  (require(dplyr))} 

if(!exists("parameter_short") || is.null(parameter_short)){parameter_short <-  FALSE}
if(is_null_or_not_exist(columns_to_keep)){parameter_columns_to_keep <- c("Precision"     ,                   "unit"      ,                      "Values dataset 1"      ,"Values dataset 2"      ,                               "Loss / Gain",
   "Difference (in %)"          ,      "Dimension"   ,       "Difference in value")} else {parameter_columns_to_keep <- columns_to_keep}

if(is_null_or_not_exist(parameter_UNK_for_not_standards_unit)){
  parameter_UNK_for_not_standards_unit <- TRUE
}
if(is_null_or_not_exist(parameter_mapped)){parameter_mapped <- TRUE}
if(is_null_or_not_exist(parameter_filtering)){parameter_filtering <-list(species = NULL, fishingfleet = NULL)}
if(is_null_or_not_exist(time_dimension)){time_dimension = c("time_start")}


matchingList <- parameter_filtering %>% purrr::keep( ~ !is.null(.) )
```


```{r include=FALSE}

if(!exists("child_header")){child_header = "#"}
cat2 <- function(x){cat(paste0(child_header, x, " \n"))}


```



```{r eval=!child|!step_title_t_f, include=FALSE}
cat2 <- cat
```


```{r results='asis', eval=step_title_t_f}

try(cat2(step_title))

```

```{r}
`%notin%` <- Negate(`%in%`)
last_path = function(x){tail(stringr::str_split(x,"/")[[1]],n=1)}

```

```{r results='asis'}

if(!child){cat("\\clearpage")}

```




<!-- ```{r results='asis'} -->

<!-- if(exists("step") & child){  cat(paste0("## Step ", step, " from ", last_path(parameter_init), " to ", last_path(parameter_final)))} -->

<!-- ``` -->



```{r message=FALSE}

knitr::knit_hooks$set(inline = function(x) {   if(!is.numeric(x)){     x   }else{    prettyNum(round(x,2), big.mark=",")    } })

if(!(require(base))){ 
  install.packages("base") 
  (require(base))} 
if(!(require(flextable))){ 
  install.packages("flextable") 
  (require(flextable))} 
if(!(require(remotes))){ 
  install.packages("remotes") 
  (require(remotes))} 
if(!(require(utils))){ 
  install.packages("utils") 
  (require(utils))} 
if(!(require(stringr))){ 
  install.packages("stringr") 
  (require(stringr))} 
if(!(require(knitr))){ 
  install.packages("knitr") 
  (require(knitr))} 
if(!(require(DBI))){ 
  install.packages("DBI") 
  (require(DBI))} 
if(!(require(odbc))){ 
  install.packages("odbc") 
  (require(odbc))} 
if(!(require(rlang))){ 
  install.packages("rlang") 
  (require(rlang))} 
if(!(require(sf))){ 
  install.packages("sf") 
  (require(sf))} 
if(!(require(kableExtra))){ 
  install.packages("kableExtra") 
  (require(kableExtra))} 
if(!(require(readxl))){ 
  install.packages("readxl") 
  (require(readxl))} 
if(!(require(readr))){ 
  install.packages("readr") 
  (require(readr))} 
if(!(require(tidyr))){ 
  install.packages("tidyr") 
  (require(tidyr))} 
if(!(require(ggplot2))){ 
  install.packages("ggplot2") 
  (require(ggplot2))} 
if(!(require(stats))){ 
  install.packages("stats") 
  (require(stats))} 
if(!(require(RColorBrewer))){ 
  install.packages("RColorBrewer") 
  (require(RColorBrewer))} 
if(!(require(cowplot))){ 
  install.packages("cowplot") 
  (require(cowplot))} 
if(!require(sutdycatchesird)){
  install_github("BastienIRD/sutdycatchesird")
  require(sutdycatchesird)


}
if(!(require(tmap))){ 
  install.packages("tmap") 
  (require(tmap))} 
if(!(require(RPostgreSQL))){ 
  install.packages("RPostgreSQL") 
  (require(RPostgreSQL))} 
if(!(require(officer))){ 
  install.packages("officer") 
  (require(officer))} 

set_flextable_defaults(
  font.size = 10,
  font.color = "black",
  digits = 2,
  theme_fun = "theme_box"
)


#set the dataset caption styling
# knitr::opts_chunk$set(tab.cap.pre = "Table ", tab.cap.sep = ": ")

#set the dataset caption styling
if(!child){autonum <- officer::run_autonum(seq_id = "tab", bkm = "TC1", bkm_all = TRUE) # number the table, bkm (bookmark) is important as the cross-referencing is done using the bookmark
}



plotting_type <- "plot" 
if (knitr::is_html_output()){plotting_type <- "view" }
```


```{r cache=FALSE}

fSpatPlan_Convert2PacificRobinson <- function(df, buff = 0){
  
  if(!exists("df_robinson")){
    df_robinson <- df}
  return(df_robinson)
  
}




```

<!-- # ```{r justtolaunchinknittingnotoutside, include=FALSE} -->
<!-- # if(!require(dotenv)){ -->
<!-- #   install.packages("dotenv") -->
<!-- #   require(dotenv) -->
<!-- # } -->
<!-- # if(!require(geoflow)){ -->
<!-- #   install.packages("geoflow") -->
<!-- #   require(geoflow) -->
<!-- # } -->
<!-- # load_dot_env(file = "catch_server.env") -->
<!-- # config <- initWorkflow("tunaatlas_qa_global_datasets_catch.json") #ok -->
<!-- # entity <- config$metadata$content$entities[[1]] -->
<!-- # action <- entity$data$actions[[1]] -->
<!-- # opts <- action$options -->
<!-- # con <- config$software$input$dbi -->
<!-- #  -->
<!-- # ``` -->


```{r include=FALSE}

# out <- try((con <- config$software$output$dbi), silent = TRUE)
# if("try-error" %in% class(out)){con <- parameter_con}
# 
# query <- "SELECT code, st_area(geom), geom from area.cwp_grid"
# out <- try((world_sf <- st_read(con, query = query)), silent = TRUE)
# con <- DBI::dbConnect(RPostgres::Postgres() , dbname = parameter_dbname, host = parameter_host,   port = parameter_port,
#                                                        user = parameter_user,
#                                                        password = parameter_password)
# 
# world_sf <- st_read(con, query = query)

shapefile.fix <- st_read("data/world_sf.csv") %>% select(-WKT) %>% dplyr::rename(geom = geometry)


# shapefile.fix <- st_make_valid(world_sf)%>% dplyr::filter(!st_is_empty(.)) %>%dplyr::mutate(cat_geo = as.factor(dplyr::case_when(st_area == 1 ~ "1_deg", st_area == 25 ~ "5_deg", TRUE ~ ">_5_deg")))
shape_without_geom  <- shapefile.fix %>% as_tibble() %>%dplyr::select(-geom)



# query <- "SELECT  code,st_area(geom), geom from area.gshhs_world_coastlines"
# continent <- fSpatPlan_Convert2PacificRobinson(st_read(con, query = query)%>%dplyr::filter(!st_is_empty(.)))

continent <- st_read("data/continent.csv") %>% dplyr::rename(geom = geometry)


qflextable2 =function(x, captionn = NULL, autonumm = autonum, pgwidth = 6, colour = FALSE){
 y<-x
 y <- y %>% dplyr::mutate_if(is.factor, as.character) %>% dplyr::mutate_if(is.character, ~str_replace_all( ., ",", ", \n" )) %>% 
  dplyr::mutate_if(is.character,~str_replace_all( ., "_", "-" )) %>% dplyr::mutate_if(is.numeric, function(.){round(.,2)})
  flextable <- flextable(y)
  if(colour){
  flextable <- flextable %>% 
          color(~ `Difference (in % of tons)` < 0, color = "green",~ `Difference (in % of tons)`) %>% 
          color(~ `Difference (in % of tons)` >0, color = "red",~ `Difference (in % of tons)`)%>%   color(~ `Difference (in % of fish)` < 0, color = "green",~ `Difference (in % of fish)`) %>% 
          color(~ `Difference (in % of fish)` >0, color = "red",~ `Difference (in % of fish)`)%>%color(~ `Difference (in % of lines)` < 0, color = "green",~ `Difference (in % of lines)`) %>% 
          color(~ `Difference (in % of lines)` >0, color = "red",~ `Difference (in % of lines)`)
  } 
  if(!is.null(captionn)){flextable_captionned <- set_caption(flextable, caption = captionn,  style = "Table Caption")} else {flextable_captionned <- flextable}
  ft_out <- flextable_captionned %>% autofit()
  ft_out <- width(ft_out, width = dim(ft_out)$widths*pgwidth /(flextable_dim(ft_out)$widths))

  return(ft_out)

}

# qflextable2 <- function(data) {
# 
#   kableExtra::kbl(data, booktabs = TRUE, digits = 2) %>% 
#     kable_styling(latex_options =c("striped", "scale_down"))%>%
#   kable_styling(full_width = F)
# }


```

```{r results='asis', eval=FALSE}
cat2("# The data compared")
```

```{r cache=FALSE}
species_group <-  read_excel("data/SPECIES_LIST_RFMO_WITH_ERRORS.xlsx") %>% janitor::clean_names() %>%  dplyr::select(species_group, species_code) %>% dplyr::rename(species = species_code)
 cl_cwp_gear_level2 <- read_csv(file.path("data","cl_cwp_gear_level2.csv"), 
                                 col_types = cols(Identifier = col_skip(), 
                                                  Abbreviation = col_skip(), Name_Fr = col_skip(), 
                                                  Name_Es = col_skip(), Name_Ar = col_skip()))
 
 
if(is_null_or_not_exist(parameter_colnames_to_keep)){
if(parameter_fact == "catch"){colnames_to_keep <- c("fishingfleet",         "gear",                 "time_start",                 
                      "geographic_identifier","schooltype",           "species",              "catchtype",           
                      "unit",                 "value",                "source_authority")} else if(parameter_fact == "effort") {colnames_to_keep <- c("fishingfleet",         "gear",                 "time_start",                     
                      "geographic_identifier","schooltype",                           
                      "unit",                 "value",                "source_authority")}
  }else {colnames_to_keep <-parameter_colnames_to_keep}

```



```{r eval=!child, results='asis'}

isNullList <- function(x) all(!lengths(x))
if (isNullList(parameter_filtering)){cat("There are no filter on this data")} else {
  
  cat (paste0("The filter used on this data are:  \n "))
  for (i in 1:length(parameter_filtering)){
    if (parameter_filtering[i] %in% parameter_filtering & !is.null(parameter_filtering[[i]])){
      cat(paste0("***- On ", names((parameter_filtering)[i]), " : ", paste((parameter_filtering)[[i]], collapse = " ; "),"*** \n"))
    } else {""}
  }
}

```





```{r}
if (!exists("parameter_final")) {parameter_final <- NULL} 
```



```{r}
init <- readRDS(paste0(as.character(parameter_init),"/rds.rds"))
if(is_null_or_not_exist(parameter_final)){final <- init[0,] 
 unique_analyse <-  TRUE} else{
final <- readRDS(paste0(as.character(parameter_final),"/rds.rds"))
unique_analyse <- FALSE}
```


```{r include=FALSE}
if(!parameter_mapped){
try(conn <- DBI::dbConnect(RPostgres::Postgres() , dbname = parameter_dbname, host = parameter_host,   port = parameter_port, user = parameter_user,password = parameter_password))


mapping_dataset <- read.csv(paste0("data/codelist_mapping_rfmos_to_global.csv"), stringsAsFactors = F,colClasses = "character")#, entity$data$source[[2]])) #bof mais pour l'instant comme ça 
  mapping_keep_src_code <- FALSE

  source("https://raw.githubusercontent.com/eblondel/geoflow-tunaatlas/master/tunaatlas_scripts/generation/map_codelists.R")
  init <- map_codelists(conn, parameter_fact, mapping_dataset, init, mapping_keep_src_code = FALSE, summary_mapping = FALSE) #this map condelist function is to retrieve the mapping dataset used
  # final <- map_codelists(conn, parameter_fact, mapping_dataset, final, mapping_keep_src_code = FALSE, summary_mapping = FALSE)
DBI::dbDisconnect(conn)
}
```

```{r}
init <- init %>% dplyr::select(any_of(colnames_to_keep))
final <- final %>% dplyr::select(any_of(colnames_to_keep))
tidying_data_for_GTA <- function(x, time_dim, shape){
  if("geographic_identifier"%in%colnames(x)){
  x <- x%>%  dplyr::left_join(shape, by = c("geographic_identifier"="code"))
  print_map <- TRUE
  } else {print_map <- FALSE}


x <- x %>% mutate_at(all_of(time_dim), as.character)

if("cat_geo"%in%colnames(x)){
  x <- x%>%dplyr::mutate(cat_geo = as.character(cat_geo))
}
return(list(dataframe = x, print_map= print_map))
}
list_return_init <- tidying_data_for_GTA(init,time_dim = time_dimension, shape = shape_without_geom)
init <- list_return_init$dataframe
final <- tidying_data_for_GTA(final, time_dim = time_dimension, shape = shape_without_geom)$dataframe

if(!exists("print_map")){
print_map <- list_return_init$print_map
}
```



```{r}
if(parameter_fact=="catch"){
  function_dataframe_tot_filter =function(dataframe_tot_filter){
  dataframe_tot_filter <- dataframe_tot_filter %>% dplyr::left_join(species_group%>% dplyr::distinct(), by = c("species"))
  
    dataframe_tot_filter <- dataframe_tot_filter %>% dplyr::left_join(cl_cwp_gear_level2, by = c("gear" = "Code"))
    
  if ("Name_En"%in% colnames(dataframe_tot_filter)){dataframe_tot_filter <- dataframe_tot_filter%>% dplyr::rename(Gear = Name_En)%>%dplyr::mutate(gear = as.character(gear))}
  
  dataframe_tot_filter <- dataframe_tot_filter%>%dplyr::mutate(unit = dplyr::case_when(unit %in% c("MT","t","MTNO", "Tons")~ "Tons", unit %in% c("NO", "NOMT","no", "Number of fish")~"Number of fish", TRUE ~ unit)) 
  
}
init <- function_dataframe_tot_filter(init)
final <- function_dataframe_tot_filter(final)
  }


# if(!exists("titre_dataset_1")){titre_dataset_1 <- NULL}
# if(!exists("titre_dataset_2")){titre_dataset_2 <- NULL}

if (is_null_or_not_exist(parameter_titre_dataset_1)){
  titre_1 <- last_path_reduced(as.character(parameter_init))
} else {
  titre_1 <- parameter_titre_dataset_1
}


if (is_null_or_not_exist(parameter_titre_dataset_2) & !unique_analyse){
  titre_2 <- last_path_reduced(as.character(parameter_final))
  } else if (unique_analyse) {
  titre_2 <- "NONE"
} else {
    titre_2 <- parameter_titre_dataset_2
}

titre_2 <- gsub("_","-",titre_2)
titre_1 <- gsub("_","-",titre_1)

# if(nrow(init %>% dplyr::filter(unit=="Number of fish"))!=0 | nrow(final%>% dplyr::filter(unit=="Number of fish"))!=0){is_there_no <- TRUE} else{is_there_no <- FALSE}
# if(nrow(<- %>% dplyr::filter(unit=="Number of fish"))!=0 & nrow(final%>% dplyr::filter(unit=="Number of fish"))==0){all_no_lost <- TRUE} else{all_no_lost <- FALSE}

```



```{r results='asis', eval=(!parameter_short && !unique_analyse)}
try(knit_child_attention <- knitr::knit_child(text =c(
  '',
      '```{r results="asis"}', 
  'test <- 1', 
  '',
  '```',
  '',
  '*Attention ! In the following document :* \n ',
  '-***All the differences inferior to 0 corresponds to gain in captures.***', 
  '\n',
  '-***The initial dataset, refered as, dataset 1 is `r titre_1`***',
  '\n',
'-***The final dataset, refered as, dataset 2 is `r titre_2`***', 
  '\n',
'', 
''), envir = environment(), quiet= TRUE))
```

```{r results='asis', eval=(!parameter_short && !unique_analyse)}
try(cat(knit_child_attention))
```

```{r results='asis', eval=(!parameter_mapped &&  !unique_analyse) }
try(knit_mapped <- knitr::knit_child(text =c(
  '',
      '```{r results="asis"}', 
  '',
  '```',
  '',
  'In this comparison, the differences due to the mapping thas is to say, the renaming of codes to harmonize data will not be presented. The recap of the mapping is presented in annexe.',

'', 
''), envir = environment(), quiet= TRUE))
```

```{r results='asis', eval=(!parameter_mapped  & !unique_analyse)}
try(cat(knit_mapped))
```


```{r}


colnames_to_filter <- colnames(init %>% select(names(matchingList)))

names(matchingList) <- colnames_to_filter

matchingList <- lapply(matchingList, function(x){ #handling single filter
  if(length(x) == 1){
  x <- c(x, x) }else {
    x
  }

}
  )
if(is_null_or_not_exist(geographical_dimension)){geographical_dimension = "geographic_identifier"}

filtering_function= function(dataframe_to_filter, colnames_to_filter, matchingList, geo_dim, parameter_fact, parameter_UNK_for_not_standards_unit){
  if(length(colnames_to_filter)!= 0){  dataframe_to_filter <- dataframe_to_filter%>% dplyr::filter(!! rlang::parse_expr(str_c(colnames_to_filter, matchingList, sep = '%in%', collapse="&")))}
  if(  parameter_UNK_for_not_standards_unit & parameter_fact == "effort"){
    dataframe_to_filter <- dataframe_to_filter %>% dplyr::mutate(unit = ifelse(unit%in%c("HOOKS","FDAYS"), unit, "UNK" ))}
  if("geographic_identifier"%in%colnames(dataframe_to_filter)){
    dataframe_to_filter <- dataframe_to_filter %>% dplyr::rename("geographic_identifier" := {{geo_dim}})
  }
  return(dataframe_to_filter)
}
  #function to filter on all the filter_parameters

# list_init_final <- list(init, final)

# list_init_final <<- lapply(list_init_final,FUN = filtering_function, colnames_to_filter = colnames_to_filter, matchingList = matchingList)

# rapply(list_init_final, f = filtering_function, colnames_to_filter = colnames_to_filter, matchingList = matchingList, how = "replace")
# purrr::modify(list(init, final), .f = filtering_function, colnames_to_filter = colnames_to_filter, matchingList = matchingList)
formals(filtering_function)$geo_dim = geographical_dimension
formals(filtering_function)$parameter_fact = parameter_fact
formals(filtering_function)$parameter_UNK_for_not_standards_unit = parameter_UNK_for_not_standards_unit

init <- filtering_function(dataframe_to_filter = init, colnames_to_filter = colnames_to_filter, matchingList = matchingList)

if(unique_analyse){final <- init[0,]} else {final <- filtering_function(final, colnames_to_filter = colnames_to_filter, matchingList = matchingList)}



```


```{r include=FALSE}
errorfinal <- try(differences_in_optionsfinal <- readr::read_delim(paste0(parameter_final,"/options_total.txt") ,col_names = FALSE,delim="=" ) %>% dplyr::distinct(), silent = TRUE)
errorinit <- try(differences_in_optionsinit <- readr::read_delim(paste0(parameter_init,"/options_total.txt") ,col_names = FALSE,delim="=" ) %>% dplyr::distinct(), silent = TRUE)

if(!("try-error" %in% class(errorfinal))){treatment <- TRUE} else {treatment <- FALSE}
if(!("try-error" %in% class(errorinit))){options_total <- TRUE} else {options_total <- FALSE}

if(exists("no_recap_options") && no_recap_options == TRUE){options_total <- FALSE}
```


```{r eval=options_total}
differences_in_optionsinit <- readr::read_delim(paste0(parameter_init,"/options_total.txt"), col_names = FALSE, delim = "=") %>% dplyr::distinct() 
differences_in_optionsinit$X1 <- gsub(" ","",differences_in_optionsinit$X1)
differences_in_optionsinit$X1 <- gsub("options_","",differences_in_optionsinit$X1) 
differences_in_optionsinit$X2 <- gsub(" ","",differences_in_optionsinit$X2)
differences_in_optionsinit$X2 <- gsub("options_","",differences_in_optionsinit$X2) 

differences_in_optionsinit_base <- differences_in_optionsinit %>% dplyr::distinct()
```


```{r eval=treatment}
differences_in_optionsfinal <- readr::read_delim(paste0(parameter_final,"/options_total.txt"), col_names = FALSE, delim = "=") %>% dplyr::distinct() 


differences_in_optionsfinal$X1 <- gsub(" ","",differences_in_optionsfinal$X1)
differences_in_optionsfinal$X1 <- gsub("options_","",differences_in_optionsfinal$X1)
differences_in_optionsfinal$X2 <- gsub(" ","",differences_in_optionsfinal$X2)
differences_in_optionsfinal$X2 <- gsub("options_","",differences_in_optionsfinal$X2)

differences_in_optionsfinal_base <- differences_in_optionsfinal %>% dplyr::distinct()

colnames(differences_in_optionsinit) <- "Options init"

colnames(differences_in_optionsfinal) <- "Options final"


differences_in_optionsinit <- as.data.frame(stringr::str_split_fixed(differences_in_optionsinit$`Options init`, "=", 2)) %>% dplyr::rename(Options_initial =V2)%>%dplyr::filter(Options_initial!="")

differences_in_optionsfinal <- as.data.frame(stringr::str_split_fixed(differences_in_optionsfinal$`Options final`, "=", 2)) %>% dplyr::rename(Options_final =V2) %>%dplyr::filter(Options_final!="")

differences_between_options <- dplyr::full_join(differences_in_optionsfinal,differences_in_optionsinit) %>% dplyr::distinct()

differences_between_options[is.na(differences_between_options)] = "none"

differences_between_options2 <-differences_between_options %>%dplyr::filter(Options_final != Options_initial)

explenation_step <- readr::read_delim(paste0(parameter_final,"/explication.txt"), col_names = FALSE, delim = "=") %>% dplyr::distinct() 

```

```{r}
if(!exists("last_to_first")){last_to_first <- FALSE}
```


```{r results='asis', eval=(treatment & !last_to_first)}
cat("Summary of this treatment : ")
cat(explenation_step$X1)
```



```{r eval= !unique_analyse, eval=treatment}
if (nrow(differences_between_options2) == 0){
  towrite ="There are no differences between the options to create the two datasets. They are created by the same workflow."
} else { towrite ="The differences in options choosen between the two dataframes are : "
qflextable2(differences_between_options2, "Differences between the options of the two datasets")}
```


```{r results='asis', eval=(!parameter_short && !unique_analyse & treatment)}
cat(towrite)
```




```{r eval=(!parameter_short & options_total), results='asis'}
cat(ifelse(unique_analyse, "The options used to create the data frame are :", "The options used to create the initial data frame are :"))

s <-  differences_in_optionsinit_base%>% dplyr::rename("Options" = X1, "Value" = X2) %>% dplyr::mutate(Options = gsub("_","-",Options))%>% dplyr::mutate(Options = gsub("=","=\n",Options))%>% dplyr::mutate(Value = gsub("_","-",Value))%>% dplyr::mutate(Value = gsub("=","=\n",Value)) %>% dplyr::mutate(Options = gsub("NONE", "", Options))
```


```{r eval=(!parameter_short & options_total), results='asis',echo=FALSE, out.width="100%"}

qflextable2(s, captionn = "Options used in the treatment of the dataset")


```

```{r}
fonction_groupement = function(these_col, init, final){
  if(!(require(rlang))){ 
  install.packages("rlang") 
  (require(rlang))} 
# groupement_1 <- init[, value := lapply(.SD, sum), by = these_col, .SDcols = c("value")]
# groupement_1 <- groupement_1 %>% dplyr::mutate(number_lines1 = 0)%>%dplyr::mutate(value_sum_1 = dplyr::coalesce(value_sum_1, 0))%>% dplyr::mutate(unit = as.character(unit))
  # these_col <- enquo(these_col) 
groupement_1  <-   init %>%dplyr::ungroup() %>% 
  mutate(value=(value)) %>%  
  dplyr::group_by(!!!rlang::syms(these_col) ,unit) %>% dplyr::summarise(value_sum_1 = ((sum(value, na.rm=TRUE)))) %>% dplyr::ungroup() %>%dplyr::mutate(value_sum_1 = dplyr::coalesce(value_sum_1, 0))%>% dplyr::mutate(unit = as.character(unit))%>% dplyr::mutate(number_lines1 = n())

# groupement_2 <- final[, value := lapply(.SD, sum), by = these_col, .SDcols = "value"]
# groupement_2 <- groupement_2 %>% dplyr::mutate(number_lines2 = 0)%>%dplyr::mutate(value_sum_2 = dplyr::coalesce(value_sum_2, 0))%>% dplyr::mutate(unit = as.character(unit))

groupement_2  <-   final %>%dplyr::ungroup() %>% mutate(value=(value)) %>%  dplyr::group_by(!!!rlang::syms(these_col)
  #!!these_col
  ,unit) %>%  dplyr::summarise(value_sum_2 = ((sum(value, na.rm=TRUE)))) %>% dplyr::ungroup()  %>%dplyr::mutate(value_sum_2 = dplyr::coalesce(value_sum_2, 0)) %>% dplyr::mutate(unit = as.character(unit)) %>% dplyr::mutate(number_lines2 = n())

fulljoin  <-   dplyr::full_join(groupement_1, groupement_2) %>%  dplyr::mutate(value_sum_2 = dplyr::coalesce(value_sum_2, 0)) %>%dplyr::mutate(value_sum_1 = dplyr::coalesce(value_sum_1, 0))%>%dplyr::mutate(loss = value_sum_1 - value_sum_2) %>%dplyr::mutate(`Loss / Gain` = dplyr::case_when(abs(loss) <= 1 ~ "Egal", loss > 1 ~"Loss",  loss < 1 ~"Gain")) %>%
dplyr::mutate(Loss_pourcent = 100*((value_sum_1 - value_sum_2)/value_sum_1))%>%dplyr::mutate(Dimension = colnames(groupement_1[1])) %>%
dplyr::rename("Precision" = 1) %>%dplyr::mutate(Precision = as.character(Precision)) %>%dplyr::mutate(value_sum_2 = dplyr::coalesce(value_sum_2, 0))%>%dplyr::mutate(Loss_pourcent = base::ifelse(is.na(Loss_pourcent)|Loss_pourcent==-Inf, 100, Loss_pourcent)) %>% dplyr::ungroup() %>%  dplyr::mutate(loss_nb_ligne = number_lines1 - number_lines2)%>%
dplyr::mutate(`Difference in value` = (value_sum_2 - value_sum_1)) %>% #final - init
dplyr::rename(`Difference (in %)` = Loss_pourcent,
`Difference in number of lines` = loss_nb_ligne)%>%dplyr::mutate_if(is.numeric, list(~replace_na(., 0)))
}

```


```{r message=FALSE, warning=FALSE, include=FALSE, cache=FALSE}


carte_init <- fonction_groupement("fishingfleet",init, final)

Dimensions <- colnames(init)[colnames(init) != "unit" & colnames(init)!= "value"& colnames(init)!= "st_area"]
t <- carte_init[0,]


```



```{r message=FALSE, warning=FALSE, include=FALSE}
for (i in Dimensions){
  temporaire <- fonction_groupement(i,init, final)
  assign(paste0("test", i), temporaire)
  
  t <- rbind(t, temporaire)
}
```


```{r message=FALSE, warning=FALSE, include=FALSE, eval=!unique_analyse}

nb_ligne_init_millions <- nrow(init)
nb_ligne_final_millions<- nrow(final)
# 
sum_valeur_init <- sum(init$value, na.rm = TRUE)
sum_valeur_final <- sum(final$value, na.rm = TRUE)

t$Dimension <-as.character(t$Dimension)
t$Precision <-as.character(t$Precision)

strates_perdues <- t %>%dplyr::filter(value_sum_2 == 0 & `Loss / Gain` == "Loss")
strates_gagnees <- t %>%dplyr::filter(value_sum_1 == 0 & `Loss / Gain` == "Gain")
nombre_strates_perdues <- nrow(strates_perdues)
nombre_strates_gagnees <- nrow(strates_gagnees)
nombres_de_strates_totales <- nrow(t)
pourcentage_strates_perdues <- 100-(100*((nombres_de_strates_totales-nombre_strates_perdues)/nombres_de_strates_totales))
rm(init_no, init_t, final_no, final_t)
gc()

strates_perdues_first_10 <- rbind(strates_perdues,strates_gagnees) %>%dplyr::filter(`Loss / Gain` != 'Egal')%>%ungroup %>%dplyr::filter(Dimension!="geographic_identifier") %>%dplyr::group_by(`Loss / Gain`,Dimension,unit)%>%# slice(1:10) %>%
  dplyr::select(Dimension, everything())

if (nrow(strates_perdues_first_10)== 0){strates_perdues_first_10 <- rbind(strates_perdues,strates_gagnees) %>%dplyr::filter(`Loss / Gain` != 'Egal')%>%ungroup %>%dplyr::filter(Dimension!="geographic_identifier") %>%dplyr::group_by(`Loss / Gain`,Dimension,unit)%>% #slice(1:10) %>%
  dplyr::select(Dimension, everything()) }

strates_perdues_first_10[strates_perdues_first_10==""] <- "NA"
strates_perdues_first_10[is.na(strates_perdues_first_10)] <- "NA"

```

```{r results='asis', eval=!unique_analyse}
if (round(sum_valeur_init) == round(sum_valeur_final)&nrow(t %>%dplyr::filter(`Loss / Gain` != 'Egal'))==0){
  cat("There are no differences between the two datasets, this step is not changing the data in any way")
  
  knitr::knit_exit(fully = FALSE)}
```

```{r results='asis', eval=!unique_analyse}
if(parameter_short == FALSE){cat2("# Main differences \n ")}
```


```{r  eval=!unique_analyse}
units <- unique(c(unique(init$unit), unique(final$unit)))
list_units <- unlist(as.vector(lapply(units, function(.)paste0("Value in ", .))))
df <- data.frame(matrix(ncol =4, nrow = length(c(c( "Lines"), list_units ))))
init_group <- init %>% dplyr::group_by(unit) %>% dplyr::summarise(titre_test1 = sum(value)) 
final_group <- final %>% dplyr::group_by(unit) %>% dplyr::summarise(titre_test2 = sum(value)) 
nrowinit <- nrow(init)
nrowfinal <- nrow(final)
join <- dplyr::full_join(init_group, final_group) %>% mutate(across(where(is.numeric), ~replace(., is.na(.), 0))) %>% dplyr::arrange(unit) %>%dplyr::rowwise() %>%  dplyr::mutate(unit = paste0(unit)) %>% dplyr::mutate(Difference = -titre_test1 + titre_test2)%>%mutate("Difference (in %)" = 100*(Difference /titre_test1)) %>%  dplyr::rename(!!as.symbol(eval(parse(text = "titre_1"))) := titre_test1)%>% dplyr::rename(!!as.symbol(eval(parse(text = "titre_2"))) := titre_test2)


join <- qflextable(join%>% dplyr::mutate_if(is.numeric, function(.){round(.,2)})%>% dplyr::mutate(Difference= round(Difference)))%>% 
          color(~ `Difference` > 0, color = "green",~ `Difference`) %>% 
          color(~ `Difference` < 0, color = "red",~ `Difference`) %>% autofit()
join <- width(join, width = dim(join)$widths*6 /(flextable_dim(join)$widths))

join <- set_caption(join, "Summary of the difference between the two datasets")

```


```{r  eval=!unique_analyse,echo=FALSE, results='asis', out.width="100%"}

join

```


```{r echo=FALSE, eval=!unique_analyse, message=FALSE, warning=FALSE, paged.print=TRUE, results='asis'}

  strates_perdues_first_10 <- strates_perdues_first_10 %>% filter(Dimension %notin% geographical_dimension) %>% filter(Dimension %notin% time_dimension)

if (nrow(strates_perdues_first_10)!=0){


  groupe_df <- flextable::as_grouped_data(strates_perdues_first_10 %>%dplyr::mutate(`Loss / Gain` = dplyr::case_when(loss > 1~ "Loss", abs(loss)<=1 ~ "No differences", loss < 1~ "Gain", TRUE ~ NA_character_))  %>% dplyr::mutate(`Loss / Gain` = dplyr::case_when(is.na(`Loss / Gain`) ~ "Gain",value_sum_1 == value_sum_2~"Egal", TRUE ~ `Loss / Gain`))%>% dplyr::ungroup()%>%  dplyr::rename(`Values dataset 1` = "value_sum_1",`Values dataset 2` = "value_sum_2") %>% select(parameter_columns_to_keep) %>%  dplyr::group_by(Dimension, unit,`Loss / Gain`) %>% dplyr::arrange( Dimension, unit,`Loss / Gain`,desc(`Difference in value`)),groups = c("Dimension","unit","Loss / Gain"))
  cat("The stratas differences (completely lost or appearing) between the first one and the second one are:\n")
  cat(knit_print(qflextable2(groupe_df%>% select(Dimension, unit, `Loss / Gain`, Precision, `Difference in millions` = `Difference in value`), captionn = paste0("Disappearing or appearing stratas between ", titre_1, " and ", titre_2))))
  cat(paste0("They represent ", round(pourcentage_strates_perdues)," % of the total number of stratas."))
} else {towrite =("No strata is gain nor lost")}

```

```{r}

number_init_column <- as.data.frame(t(init %>% select(-value) %>% summarise_all(list(~n_distinct(.))))) %>%  dplyr::rename(!!as.symbol(eval(parse(text = "titre_1"))) := V1)
number_final_column <- as.data.frame(t(final %>% select(-value) %>% summarise_all(list(~n_distinct(.)))))%>%  dplyr::rename(!!as.symbol(eval(parse(text = "titre_2"))) := V1)

number_final_column<-number_final_column[order(row.names(number_final_column)), ,drop=F]
number_init_column<-number_init_column[order(row.names(number_init_column)), ,drop=F]


s <- cbind(number_init_column , number_final_column ) %>% mutate_all(as.numeric)
s$Difference <- s[,2]-s[,1]

rownames(s) <- paste0("Number of ", rownames(s))

```




```{r eval=!unique_analyse}
if(!(require(tibble))){ 
  install.packages("tibble") 
  (require(tibble))} 
qflextable2(s %>% tibble::rownames_to_column(" "), captionn = "Comparison of number of stratas between the two datasets")
```


```{r results='asis', eval=parameter_short}
exit <- "This document only presents the summary of the differences between the two datasets. If you need a more detailed summary please provide FALSE as argument for the 'short' parameter"
if(child){exit <- ""}
if (parameter_short){knitr::knit_exit(exit, fully = FALSE)}


```


```{r results='asis'}
title_introduction <- "# Introduction to the two datasets"
if(!unique_analyse){
  cat2(title_introduction)
  }

```

We first present the main characteristics of each dimension.

```{r results='asis'}
cat2("## Time coverage")
```

We present the evolution of value in every unit available.

```{r include=FALSE}
time_dimension_list_groupped <- lapply(time_dimension, fonction_groupement, init = init, final = final)

time_dimension_list_groupped_diff <- lapply(time_dimension_list_groupped, function(x){x %>%dplyr::mutate(Time = as.Date(Precision))%>%  dplyr::rename(`Values dataset 1` = "value_sum_1",`Values dataset 2` = "value_sum_2")%>% pivot_longer(cols = c(`Values dataset 1`, `Values dataset 2`), names_to = "Dataset", values_to ="Values") %>%dplyr::mutate(Dataset = dplyr::case_when(Dataset == "Values dataset 1" ~ titre_1 , TRUE ~ titre_2)) %>% dplyr::distinct()})
```


```{r}

if(unique_analyse){
  time_dimension_list_groupped_diff <- lapply(time_dimension_list_groupped_diff, function(x){x %>% filter(Values!=0)})
}

map <- lapply(time_dimension_list_groupped_diff, function(x){ggplot(x) +
aes(
x = Time,
y = Values,
fill = Dataset,
colour = Dataset,
group = Dataset
) +
geom_line(size = 0.5) +
scale_fill_hue(direction = 1) +
scale_color_hue(direction = 1) +
theme_dark() +
theme(legend.position = "top") +
facet_wrap(vars(unit), nrow = 2L)+
labs(x = unique(x$Dimension), y = "Values")+
facet_grid("unit", scales = "free_y")})

```


```{r}
function_knitting <- function(x){
assign("Dimension2", gsub("_", "", unique(x$data$Dimension)), envir = environment())
assign("y", x, envir = environment())
title_knit <- paste0("Evolutions of values for the dimension ", Dimension2, " for ", `titre_1`, " and ",`titre_2`, " dataset ")
if(nrow(final)==0){title_knit = paste0("Evolutions of values for the dimension ", Dimension2, " for ", `titre_1`, " dataset ")}
knitr::knit_child(text =c('```{r fig.cap=`title_knit`, fig.align = "center", out.widht = "100%"}',
'',
'',
'(y)',
'',
'```'), envir = environment(), quiet= TRUE)
}

map_unit_knit_list <- lapply(map, FUN = function_knitting)
```

```{r results='asis'}
cat(unlist(map_unit_knit_list), sep = "\n")
```


```{r}

time_dimension_list_groupped_diff_cumulated <- lapply(time_dimension_list_groupped_diff, 
                                                      function(x){
x <- x %>%dplyr::mutate(Time = as.Date(Precision))%>% arrange(Precision) %>%dplyr::group_by(unit, Dataset) %>% dplyr::mutate(`Cumulated values` = cumsum(`Values`)) %>% dplyr::distinct()
})

time_dimension_list_groupped_diff_cumulated <- lapply(time_dimension_list_groupped_diff_cumulated, function(x){
ggplot(x) +
    aes(
      x = Time,
      y = `Cumulated values`,
      colour = Dataset
    ) +
    geom_line(size = 0.5) +
    scale_color_hue(direction = 1) +
    theme_minimal() +
    facet_wrap(vars(unit), scales = "free", ncol = 2) +
    labs(x = unique(x$Dimension))+guides(fill=guide_legend(title="Dataset"))
  })

map_unit_knit_list_cumulated <- lapply(time_dimension_list_groupped_diff_cumulated, FUN = function_knitting)
```

```{r results='asis'}
cat(unlist(map_unit_knit_list_cumulated), sep = "\n")
```

```{r fig.cap=paste0("Cumulated ", parameter_fact, " evolution by unit for ", `titre_1`, " and ", `titre_2` , " dataset"), eval=FALSE}
ggplot_capt_time
```

```{r eval =print_map}
fonction_empreinte_spatiale = function(variable_affichee){
  selection = function(x){x %>% dplyr::ungroup() %>% dplyr::select(geographic_identifier, value, cat_geo, unit)}
  Initial_dataframe <-selection(init)
  Final_dataframe <-selection(final)
  geo_data <- gdata::combine(`Initial_dataframe`, `Final_dataframe`)
  rm(`Initial_dataframe`, `Final_dataframe`)
  gc()
  geo_data <- geo_data %>% dplyr::mutate(source = dplyr::case_when(source == "Initial_dataframe"~  eval(parse(text = "titre_1")),source == "Final_dataframe"~ eval(parse(text = "titre_2")), TRUE ~ "Error"))
  inner_join <- st_as_sf(geo_data%>% dplyr::group_by(geographic_identifier, unit,source)  %>%  dplyr::summarise(value = sum(value, na.rm = TRUE))  %>% dplyr::filter(value != 0) %>% dplyr::inner_join(shapefile.fix, by = c("geographic_identifier"="code")))
  
  if(nrow(inner_join %>% dplyr::filter(unit == variable_affichee)) != 0){
    
    
    
    
    if (plotting_type == "view"){image <- tm_shape(inner_join %>% dplyr::filter(unit == variable_affichee))+
      tm_fill("value", palette="RdYlGn", style="cont", n=8,
              id="name", midpoint = 0) +
      tm_layout(legend.outside = FALSE) + tm_facets(by=c("cat_geo","source"), free.scales = TRUE)} else {image <- tm_shape(inner_join %>% dplyr::filter(unit == variable_affichee))+
        tm_fill("value", palette="RdYlGn", style="cont", n=8,
                id="name", midpoint = 0) +
        tm_layout(legend.outside = FALSE) + tm_facets(by=c("cat_geo","source"), free.scales = TRUE)+tm_shape(continent)+tm_borders()}
    
    return(list(image, variable_affichee))
  }
}

```


```{r eval=print_map}
map_unit_knit = function(map){
  # if (deparse(substitute(unit)) == "X[[i]]"){ #for sapply function bug
  # assign("r", unit, envir = environment())
  # }else {  assign("r", substitute(unit), envir = environment())}
  assign("unit_name_map", map[2][[1]], envir = environment())
  assign("map_for_knit", map[1][[1]], envir = environment())
  knitr::knit_child(text = c(
    '',
    '',
    '```{r}', 
    'dimension_title <- gsub("_","..",unit_name_map)',
    '```',
    '',
    '```{r,fig.cap = paste0("Distribution in value for the unit : ",(unit_name_map)), out.width = "100%"}',
    '',
    'map_for_knit',
    '```',
    '',
    ''
 ), envir = environment(), quiet= TRUE)
    }
```


```{r eval=print_map}

map_unit <- lapply(unique(t$unit), FUN = fonction_empreinte_spatiale)


```



\clearpage

```{r results='asis', eval=print_map}
cat2("## Spatial coverage ")
```


```{r results='asis', eval=print_map}
tmap_mode(plotting_type)

number_of_cat_geo <- length(unique(testcat_geo$Precision))
cat_geo <- paste(as.list(unique(testcat_geo$Precision)), collapse = " ; ")

```

```{r eval=print_map,results='asis'}

try(knit_child_map_printing <- knitr::knit_child(text =c(
    '',
  '```{r results="asis"}', 
  '',
  '```',
  '',
  'We represent spatial coverage, faceted by geographical category. The geographical category depends on the area of the geographic polygon. In this case there are `r number_of_cat_geo` categories which are `r cat_geo`. The category is made on the area, also different shapes could be included in the same geographical category (example 5x10, 10x5 and 25x2).', 
   '\n',
  ''

  ), envir = environment(), quiet= TRUE))


```



```{r eval=print_map}
try(cat(knit_child_map_printing))
```





```{r echo=FALSE, results='asis', eval=print_map}
try(map_unit_knit_list <- lapply(map_unit, FUN = map_unit_knit ))
# purrr::imap(map_unit, map_unit_knit)
# test <- map_unit[1:2]
# t <- lapply(map_unit, FUN = function(x, y = names(x)){
#   name <- x[2][[1]]
#   plot <- x[1][1]
#   print(plot)
#   print(summary(plot))
#   print(class(plot))
# }
 # )

```


```{r echo=FALSE, results='asis', eval=print_map}

try(cat(unlist(map_unit_knit_list), sep = "\\clearpage"))


```

\clearpage


```{r results='asis'}

cat2("## Repartition of the data for the other dimensions")

```

We check the distribution of the value of each dimension and each unit.


<!-- ```{r} -->
<!-- formals(resume_knit_child)$titre_1 <- titre_1 -->
<!-- formals(resume_knit_child)$titre_2 <- titre_2 -->
<!-- ``` -->


```{r }
pie_chart_2_default <- studycatchesird::pie_chart_2
formals(pie_chart_2_default)$titre_1 <- titre_1
formals(pie_chart_2_default)$titre_2 <- titre_2
# formals(pie_chart_2_default)$first <- init
# formals(pie_chart_2_default)$second <- final
# if ("Gear"%in% colnames(init) & "Gear"%in% colnames(final) ){
  # list_pie_chart <- list("fishingfleet","source_authority","Gear")} else {
    list_pie_chart <- list(setdiff(colnames_to_keep, unlist(list(time_dimension, geographical_dimension, "unit", "value", "time_end"))))[[1]]
    # }

# t <- pie_chart_2_default(fishingfleet, init, final, topn = 1)
# if(unique_analyse){pie_charts_multiple <- lapply(list_pie_chart,FUN = pie_chart_2_default, first = init, topn = 4)}
# try(pie_charts_multiple <- lapply(list_pie_chart,FUN = pie_chart_2_default, first = init, second = final, topn = 4), silent = TRUE)
# 
# pie_charts_multiple <- lapply(list_pie_chart,FUN = function_pie_chart_df, first = init, second = final2, topn = 4)

```


<!-- ```{r eval=FALSE} -->
<!-- pie_charts_multiple <- lapply(list_pie_chart,FUN = resume_knit_child,  first = init, second = ifelse(!unique_analyse, final, NULL), dataframe_yes_no = ifelse(!unique_analyse, TRUE, FALSE)) -->
<!-- ``` -->


<!-- ```{r results='asis', eval=TRUE} -->

<!-- cat(unlist(pie_charts_multiple), sep = "\\clearpage") -->



<!-- ``` -->

```{r}
function_pie_chart_df <- function(dimension, ...){
  formals(pie_chart_2_default)$dimension <- dimension
  dimension_returned <- dimension
  pie_chart = pie_chart_2_default(...)
  if(exists("pie_chart$df")){
    df = pie_chart$df
  pie_chart = pie_chart$plot} else{
    pie_chart = pie_chart
    df = NULL}

if(!is.null(df)){
df <- qflextable2(df, captionn = paste0("Strata movement for the dimension : ", dimension_returned))}
  return(list(pie_chart=pie_chart,df=df, dimension=dimension_returned))
}
```



```{r}
resume_knit_child = function(x){
  
  knitr::knit_child(text = c(
    '',
    '```{r}', 
    'dimension_title <- gsub("_","..",x$dimension)',
    '',
    '```',
    '',
    '',
    '',
    '```{r results = "asis" ,fig.cap = paste0("Distribution in value for the dimension : ",(dimension_title))}',
    '',
    'x$pie_chart',
    '```',
    '',
    '',
    '',
    '```{r results = "asis", eval= !is.null(x$df)}',
    'x$df',
    '',
    '',
    '```',
    '',
    '', 
    ''




  ), envir = environment(), quiet= TRUE)
}
```


```{r}
if(!unique_analyse){pie_charts_multiple <- lapply(list_pie_chart,FUN = function_pie_chart_df, first= init, second = final, topn = 5)}else{pie_charts_multiple <- lapply(list_pie_chart,FUN = function_pie_chart_df, first= init, topn = 5, title_yes_no = FALSE )}
```

```{r eval=unique_analyse}
figures<- lapply(pie_charts_multiple, function(x){x$pie_chart})
dimension_title_subfigures <- lapply(pie_charts_multiple, function(x){paste0("Distribution in value for the dimension : ", x$dimension)})


```

```{r eval=!unique_analyse}
dimension_title_subfigures <- c("","")
```


```{r echo=FALSE, eval=unique_analyse, fig.cap='Other dimensions', fig.subcap=c(unlist(gsub("_","..",dimension_title_subfigures))), fig.ncol = 2, out.width = "50%", fig.align = "center"}
for (i in figures){plot(i)}
```


```{r eval=!unique_analyse}
pie_chart_knit <- lapply(pie_charts_multiple, FUN = resume_knit_child)

```

```{r results='asis', eval=!unique_analyse}
cat(unlist(pie_chart_knit),  sep = "\n")
```


```{r eval=unique_analyse}
knitr::knit_exit(fully = FALSE)
```

\clearpage

```{r results='asis'}
cat2("# Differences between the two datasets")
```

```{r results='asis'}
cat2("## Differences in temporal data")
```

Here is represented the differences in percent for each year.

```{r}


map <- lapply(time_dimension, function(filtering_unit, dataframe){ggplot(dataframe%>% dplyr::filter(Dimension == filtering_unit)%>%dplyr::mutate(Time = as.Date(Precision))) +
aes(
x = Time,
y = `Difference (in %)`) +
geom_line(size = 0.5) +
scale_fill_hue(direction = 1) +
theme(legend.position = "top") +
facet_wrap(vars(unit), nrow = 2L)+theme_minimal()+
labs(x = filtering_unit)+
facet_grid("unit", scales = "free_y")}, dataframe = t)

```


```{r}
function_knitting_difference <- function(x){
assign("Dimension2", gsub("_", "", unique(x$data$Dimension)), envir = environment())
assign("y", x, envir = environment())
knitr::knit_child(text =c('```{r fig.cap=paste0("Differences in percent of value for temporal dimension :  ", Dimension2, " between ", `titre_1`, " and ",`titre_2`, " dataset ")}',
'',
'',
'(y)',
'',
'```'), envir = environment(), quiet= TRUE)
}

map_unit_knit_list <- lapply(map, FUN = function_knitting)
```

```{r results='asis'}
cat(unlist(map_unit_knit_list), sep = "\n")
```



\clearpage

```{r results='asis'}

cat2("## Differences in geographical data")

```


```{r eval=FALSE, include=FALSE, out.width="100%"}
tmap_mode(plotting_type)
formals(tm_shape)$drop.empty_facets <- FALSE

inner_join <- dplyr::inner_join(shapefile.fix,(t %>%dplyr::filter(Dimension == "geographic_identifier")) , by = c("code"="Precision"))%>%dplyr::mutate(`Impact on the data` = as.factor(dplyr::case_when(`Difference (in %)` == 0 ~ 'No differences', `Difference (in %)` == 100~'All data different',`Difference (in %)` < 0 ~ "Gain", TRUE ~ 'Loss')))

if (nrow(inner_join %>%dplyr::filter(`Impact on the data` == 'All data different'))!=0 & nrow(inner_join %>%dplyr::filter(`Impact on the data` == 'No differences'))!=0){
  if(plotting_type == "plot"){
    image <- tm_shape(dplyr::inner_join(shapefile.fix,(t %>%dplyr::filter(Dimension == "geographic_identifier")) , by = c("code"="Precision")) %>% dplyr::filter("Difference (in %)" != 100 & "Difference (in %)" != 0 )) +
      tm_fill("Difference (in %)", palette="RdYlGn", style="cont", n=8,
              id="name", midpoint = 0)+ tm_shape(inner_join %>%dplyr::filter(`Impact on the data` == 'No differences')) + tm_borders(col="skyblue")+tm_shape(inner_join %>%dplyr::filter(`Impact on the data` == 'All data different')) +tm_borders(col="red")+tm_facets(by = c("unit", "cat_geo"),free.coords = FALSE, free.scales = FALSE)+
      tm_layout(legend.outside = TRUE)+tm_shape(continent)+tm_borders()} else {image <- tm_shape(dplyr::inner_join(shapefile.fix,(t %>%dplyr::filter(Dimension == "geographic_identifier")) , by = c("code"="Precision"))%>% dplyr::filter("Difference (in %)" != 100 & "Difference (in %)" != 0 )) +
        tm_fill("Difference (in %)", palette="RdYlGn", style="cont", n=8,
                id="name", midpoint = 0)+ tm_shape(inner_join %>%dplyr::filter(`Impact on the data` == 'No differences')) + tm_borders(col="skyblue")+tm_shape(inner_join %>%dplyr::filter(`Impact on the data` == 'All data different')) +tm_borders(col="red")+tm_facets(by = c("unit", "cat_geo"),free.coords = FALSE, free.scales = FALSE)+
        tm_layout(legend.outside = TRUE)}
  #   tmap::tmap_save(image,"image2.png")
  # # mapshot(image, file = "image.png")
  # knitr::include_graphics("image2.png")
  image
} else{
  
  image <- tm_shape(dplyr::inner_join(shapefile.fix,(t %>%dplyr::filter(Dimension == "geographic_identifier")) , by = c("code"="Precision"))%>% dplyr::filter("Difference (in %)" != 100 & "Difference (in %)" != 0 )) +
    tm_fill("Difference (in %)", palette="RdYlGn", style="cont", n=8,
            id="name", midpoint = 0)+ tm_facets(by = c("unit", "cat_geo"),free.coords = FALSE, free.scales = FALSE)+
    tm_layout(legend.outside = TRUE) +tm_shape(continent)+tm_borders()
  image
  #   tmap::tmap_save(image,"image3.png")
  # # mapshot(image, file = "image.png")
  # knitr::include_graphics("image3.png")
  
}
```



```{r eval=FALSE}

tmap_mode(plotting_type)
formals(tm_shape)$drop.empty_facets <- FALSE

inner_join <- dplyr::inner_join(shapefile.fix,(t %>%dplyr::filter(Dimension == "geographic_identifier")) , by = c("code"="Precision"))%>%dplyr::mutate(`Impact on the data` = as.factor(dplyr::case_when(`Difference (in %)` == 0 ~ 'No differences', `Difference (in %)` == 100~'All data different',`Difference (in %)` < 0 ~ "Gain", TRUE ~ 'Loss'))) 
minimum <- abs(min(t$`Difference (in %)`))
t_filtered <- dplyr::inner_join(shapefile.fix,(t %>%dplyr::filter(Dimension == "geographic_identifier")) , by = c("code"="Precision")) %>% dplyr::group_by(unit,cat_geo) %>%  dplyr::mutate(`Difference (in %)` = log(`Difference (in %)` + abs(min(`Difference (in %)`)) +1)) %>% dplyr::filter(!(value_sum_1 ==0 & value_sum_2==0))
if (nrow(inner_join %>%dplyr::filter(`Impact on the data` == 'All data different'))!=0 & nrow(inner_join %>%dplyr::filter(`Impact on the data` == 'No differences'))!=0){
  if(plotting_type == "plot"){
    image <- tm_shape(t_filtered)  +
      tm_fill("Difference (in %)",style = "equal", palette = "Blues", auto.palette.mapping = FALSE, midpoint = 0)+tm_facets(by = c("unit", "cat_geo"),free.coords = FALSE, free.scales = FALSE)+
      tm_layout(legend.outside = TRUE)+tm_shape(continent)+tm_borders()
    } else {
      image <- tm_shape(t_filtered) +
        tm_fill("Difference (in %)", palette="PiYG", style="cont", n=8,
                id="name", midpoint = 0)+tm_facets(by = c("unit", "cat_geo"),free.coords = FALSE, free.scales = FALSE)+
        tm_layout(legend.outside = TRUE)}


} else{
  
  image <- tm_shape(t_filtered%>% dplyr::filter("Difference (in %)" != 100 & "Difference (in %)" != 0 )) +
    tm_polygons(col = "Difference (in %)", palette="PiYG", style="cont", n=8,
            id="name", midpoint = 0,interval.closure	= "left")+ tm_facets(by = c("unit", "cat_geo"),free.coords = FALSE, free.scales = FALSE)+
    tm_layout(legend.outside = TRUE) +tm_shape(continent)+tm_borders()

}
```




```{r eval = FALSE, echo=FALSE, fig.cap=paste0("Geographical differences in % between ", titre_1, " and ", titre_2), results='asis'}


image



```



```{r eval=FALSE}



fonction_empreinte_spatiale_diff  = function(unit, plotting_type, shapefile_fix_function, t_filtered, percent = FALSE){
  if (deparse(substitute(unit)) == "X[[i]]"){ #for sapply function bug
  assign("new_name", paste0("Difference in millions of ",unit), envir = globalenv())
    if(percent){assign("new_name", paste0("Difference (in %) of ", unit), envir = globalenv())}
    }else {  assign("new_name", paste0("Difference in millions of ", substitute(unit)), envir = globalenv())
    if(percent){assign("new_name", paste0("Difference (in %) of ", substitute(unit)), envir = globalenv())}
    }
  
  enquo_unit <- enquo(unit)
  dataset <- dplyr::inner_join(shapefile_fix_function,(t_filtered%>% dplyr::ungroup() %>%dplyr::filter(Dimension == ("geographic_identifier")) %>% dplyr::filter(unit == !!enquo_unit)) , by = c("code"= "Precision"))
  if(percent){
  dataset <- dataset%>%  dplyr::rename(!!as.symbol(eval(parse(text = "new_name"))) := "Difference (in %)")} else {
  dataset <- dataset%>%  dplyr::rename(!!as.symbol(eval(parse(text = "new_name"))) := "Difference in value")}
image_child <- tm_shape(dataset) +tm_fill(eval(parse(text = "new_name")), palette= ("-PiYG"), id= ("name"), midpoint = 0)+tm_facets(by =   c("cat_geo", "Loss / Gain"),free.coords = FALSE)+tm_borders(lwd = 0.05)
  if(plotting_type == "plot"){image_child <-image_child+tm_shape(continent)+tm_borders()}
  return(list(image_child,unit))
}

tmap_mode(plotting_type)
formals(tm_shape)$drop.empty_facets <- FALSE
formals(fonction_empreinte_spatiale_diff)$plotting_type <- plotting_type
formals(fonction_empreinte_spatiale_diff)$shapefile_fix_function <- shapefile.fix
formals(fonction_empreinte_spatiale_diff)$t_filtered <- t_filtered
# t_filtered <- t

map_diff <- lapply(unique(t_filtered$unit), fonction_empreinte_spatiale_diff)
map_diff

knit_child_map =function(list_map_unit){
  assign("unit_name_map", list_map_unit[2][[1]], envir = environment())
  assign("map_for_knit", list_map_unit[1][[1]], envir = environment())

  knit_child(text = c(
    '```{r results = "asis"}',
    '',
    'unit_title <- gsub("_","..",unit_name_map)',
    '```',
    '',
    '',
    '```{r results="asis", fig.cap = paste0("Map of the differences between two datasets for the unit ", unit_title)}',
'',
  'map_for_knit',
  '',
    '```',
  '',
  '',''),
  envir = environment(), quiet= TRUE)
}

map_plotted_knit <- lapply(map_diff, knit_child_map)
formals(fonction_empreinte_spatiale_diff)$percent <- TRUE
map_diff_percent <- lapply(unique(t_filtered$unit), fonction_empreinte_spatiale_diff)

map_plotted_percent <- lapply(map_diff_percent, knit_child_map)

```


```{r eval=FALSE}


inner_join <- dplyr::inner_join(shapefile.fix,(t %>%dplyr::filter(Dimension == "geographic_identifier")) , by = c("code"="Precision"))%>%dplyr::mutate(`Impact on the data` = as.factor(dplyr::case_when(`Difference (in %)` == 0 ~ 'No differences', `Difference (in %)` == 100~'All data different',`Difference (in %)` < 0 ~ "Gain", TRUE ~ 'Loss')))
t_filtered <- t #%>% dplyr::filter(`Difference (in %)` >= -100)
```




```{r eval=FALSE}

if (nrow(inner_join %>%dplyr::filter(`Impact on the data` == 'All data different'))!=0 & nrow(inner_join %>%dplyr::filter(`Impact on the data` == 'No differences'))!=0){
   try(restest <- lapply(unique(t_filtered$unit), FUN = knit_child_map))
}

formals(knit_child_map)$percent <- TRUE

if (nrow(inner_join %>%dplyr::filter(`Impact on the data` == 'All data different'))!=0 & nrow(inner_join %>%dplyr::filter(`Impact on the data` == 'No differences'))!=0){
   try(restest_percent <- lapply(unique(t_filtered$unit), FUN = knit_child_map))
}
```


```{r eval=FALSE,echo=FALSE, results='asis'}


try(cat(unlist(map_plotted_knit), sep = "\\clearpage"))


```

```{r eval=FALSE, echo=FALSE, results='asis'}


try(cat(unlist(map_plotted_percent), sep = "\\clearpage"))


```

Here is represented for each area the polygons keeping all the initial information, the ones losing a part and the ones losing all the information. 

```{r}
breaks <- dplyr::inner_join(shapefile.fix,(t %>%dplyr::filter(Dimension == "geographic_identifier")) , by = c("code"="Precision")) %>%dplyr::mutate(`Impact on the data` = dplyr::case_when(`Difference (in %)` == -Inf ~"Appearing data", -Inf<`Difference (in %)`  & `Difference (in %)`<= -100 ~"Gain (more than double)" ,  -100<`Difference (in %)`  & `Difference (in %)`<0 ~ "Gain",`Difference (in %)`==0~"No differences" ,0<`Difference (in %)`  & `Difference (in %)`<100 ~ "Loss",`Difference (in %)` ==100 ~  "All data lost" ))

breaks <- breaks %>% ungroup()


breaks$`Impact on the data` <- factor(breaks$`Impact on the data`, levels = c("Appearing data", "Gain (more than double)","Gain", "No differences", "Loss", "All data lost"))

 image <- tm_shape(breaks)+tm_fill("Impact on the data", palette="-PiYG",  id="name")+ tm_facets(by = c("unit", "cat_geo"), free.scales = FALSE,free.coords = TRUE)+    tm_layout(legend.outside = TRUE)

if(plotting_type == "plot"){image <- image  +tm_shape(continent)+tm_borders()}

 

```




```{r results='asis', out.width="100%", fig.cap=paste0("Spatial differences between ", titre_1, " and ", titre_2, " dataset."), eval=print_map}


image


```



```{r eval=print_map}
init <- init%>% mutate(st_area=as.numeric(st_area))
out <- try(spatial_coverage_init <-sum((init %>% dplyr::filter(value > 0)%>% select(geographic_identifier)%>%dplyr::distinct()%>%dplyr::left_join(shape_without_geom %>% mutate(st_area=as.numeric(st_area)), by = c("geographic_identifier"="code")) %>% distinct())$st_area, na.rm = TRUE))

if("try-error" %in% class(out)){knitr::knit_exit(paste0("nrow init = ", nrow(init)))}
```


```{r eval=print_map}
final <- final%>% mutate(value=as.numeric(value))
out <- try(spatial_coverage_final <- as.numeric(sum((final %>% dplyr::filter(value > 0)%>% select(geographic_identifier)%>%dplyr::distinct() %>%dplyr::left_join(shape_without_geom%>% mutate(st_area=as.numeric(st_area)), by = c("geographic_identifier"="code")) %>% distinct)$st_area, na.rm = TRUE)))
if("try-error" %in% class(out)){knitr::knit_exit(paste0("nrow_final= ",nrow(final)))}

difference_coverage <- spatial_coverage_init - spatial_coverage_final
gain_loss <- ifelse(difference_coverage >0, "Loss" ,"Gain")
```

The coverage difference is `r difference_coverage` km square. (`r gain_loss`)

\clearpage

```{r results='asis'}
cat2("## Loss and gain for each strata")
```

This section detail the differences that are observed between the dataframe ***`r titre_1`*** and ***`r titre_2`***.

```{r}
disappearing_strates <- t %>%dplyr::filter(value_sum_2 == 0)
```

```{r}

topn <- 6

```


```{r}

if(length(unique(init$species)) < 8){
topn <- (length(unique(init$species)))
}

```


```{r results='asis'}
cat2("## The differences for each dimension")
```


We will look for each dimension the `r topn` most important differences without presenting the stratas completely appearing or desappearing.

```{r}

valeur_totale <- sum(init$value, na.rm = TRUE)
ligne_totale <- nrow(init)

unit <- t  %>% dplyr::filter(`Difference (in %)` %notin% c(0,100, -Inf) & (value_sum_1!=0 )& value_sum_2!=0 ) 


if(nrow(unit != 0)){unit <- unit%>%dplyr::mutate(`Loss / Gain` = base::ifelse(loss >= 0, "Loss", "Gain")) %>% dplyr::mutate(`Loss / Gain` = dplyr::case_when(is.na(`Loss / Gain`) ~ "Gain", value_sum_1 == value_sum_2 ~"Egal", TRUE ~ `Loss / Gain`))%>%dplyr::mutate(Dimension = as.factor(Dimension)) %>%  dplyr::group_by(Dimension, unit,`Loss / Gain`) %>% arrange(desc(`Difference (in %)`)) %>% dplyr::mutate(id = row_number())%>%  dplyr::mutate(Precision = as.factor(base::ifelse(id>(topn),paste0("Others"),paste0(as.character(Precision))))) %>% dplyr::ungroup() %>%dplyr::group_by(`Loss / Gain`,Dimension,Precision, unit) %>%dplyr::summarise(across(is.numeric, sum)) %>%dplyr::mutate(`Difference (in %)` = (`Difference in value`/value_sum_1)*100) %>%dplyr::select(-id, -number_lines2)%>%dplyr::group_by(`Loss / Gain`,Dimension,unit) %>%  arrange(Dimension,unit,desc(`Difference (in %)`)) %>% mutate(Other_column = ifelse(Precision == "Others", 1, 0))
t3 <- as_grouped_data(unit %>% dplyr::ungroup()%>%  dplyr::rename(`Values dataset 1` = "value_sum_1",`Values dataset 2` = "value_sum_2")%>% dplyr::filter(`Loss / Gain` != "Egal")%>%dplyr::select(parameter_columns_to_keep,Other_column)%>%dplyr::mutate_if(is.numeric, round, digits=2) %>% dplyr::group_by(Dimension, unit,`Loss / Gain`) %>% dplyr::arrange( Dimension, unit,`Loss / Gain`, Other_column,desc(abs(`Difference in value`)) ) %>% dplyr::select(-Other_column),groups = c("Dimension","unit"#,"Loss / Gain"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ))
} else {to_cat <- "There are no differences between stratas aside the appearing and disappearing ones"}

```

```{r paged.print=TRUE, results='asis'}



if(nrow(unit != 0)){qflextable2(t3, captionn = "Difference between stratas of the two datasets")} else{cat(to_cat)}

```

```{r numberstrataswithtoutmapping, eval=!parameter_mapped}
initnotmapped <- readRDS(paste0(as.character(parameter_init),"/rds.rds"))
finalnotmapped <- readRDS(paste0(as.character(parameter_final),"/rds.rds"))

initnotmapped <- initnotmapped %>% dplyr::select(any_of(colnames_to_keep))
finalnotmapped <- finalnotmapped %>% dplyr::select(any_of(colnames_to_keep))


number_init_column <- as.data.frame(t(initnotmapped %>% select(-value) %>% summarise_all(list(~n_distinct(.))))) %>%  dplyr::rename(!!as.symbol(eval(parse(text = "titre_1"))) := V1)
number_final_column <- as.data.frame(t(finalnotmapped %>% select(-value) %>% summarise_all(list(~n_distinct(.)))))%>%  dplyr::rename(!!as.symbol(eval(parse(text = "titre_2"))) := V1)

rm(initnotmapped)
rm(finalnotmapped)

s <- cbind(number_init_column , number_final_column ) %>% mutate_all(as.numeric)
s$Difference <- s[,2]-s[,1]

rownames(s) <- paste0("Number of ", rownames(s))

```

```{r eval=!unique_analyse, eval=!parameter_mapped}
if(!(require(tibble))){ 
  install.packages("tibble") 
  (require(tibble))} 
qflextable2(s %>% tibble::rownames_to_column(" "), captionn = "Comparison of number of stratas between the two datasets with including the differences due to the mapping of codelist")
```


```{r eval=parameter_mapped || child}
knitr::knit_exit(fully = FALSE)
```


```{r eval=!parameter_mapped, results='asis'}
cat2("# Annexe")
```

```{r eval=!parameter_mapped}
df_mapping_final_this_dimension <- read_csv("data/mapping_codelist_summary.csv")
t <- df_mapping_final_this_dimension %>% select(-trg_codingsystem)%>%dplyr::group_by(across(everything())) %>%  dplyr::mutate(src_codingsystem = unlist(str_split(src_codingsystem, "_"))[1]) %>% dplyr::ungroup() 

i <-pivot_wider(t %>% dplyr::mutate(src_code = as.character(src_code)), names_from = source_authority,names_prefix = "Ancient name for ", values_from = "src_code", values_fn = list)  %>% dplyr::rename("New code" = trg_code) %>% dplyr::rename(Dimension = src_codingsystem)%>%
    relocate(Dimension)
t <- as_grouped_data(i, groups = c("Dimension")) %>% as.data.frame() %>% dplyr::ungroup()
s <- t %>% rowwise() %>% dplyr::mutate(Dimension = ifelse(is.na(Dimension), " ", Dimension)) %>% dplyr::ungroup() %>% as.data.frame() %>% dplyr::mutate(`New code` = ifelse(is.na(`New code`) &  (Dimension == " "), "UNK", `New code`))
s[is.na(s)] <- ""

```

```{r eval=!parameter_mapped}
kable(s, caption = "Replacement code during the mapping codelist treatment")
```



<!-- ```{r eval=!unique_analyse} -->
<!-- if(!(require(tibble))){  -->
<!--   install.packages("tibble")  -->
<!--   (require(tibble))}  -->
<!-- qflextable2(s %>% tibble::rownames_to_column(" "), captionn = "Replacement code during the mapping codelist treatment") -->
<!-- ``` -->



