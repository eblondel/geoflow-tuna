---
title: 'Comparison of two data sets at different levels/options of the tuna atlas'
date: "`r format(Sys.time(), '%d %B, %Y')`"
author:
  - name: Bastien Grasset
    email: bastien.grasset@ird.fr
    affiliation:
      - IRD
      - MARBEC
  - name: Emmanuel Blondel
    affiliation: FAO
  - name: Julien Barde
    affiliation:
      - IRD
      - MARBEC
  - name: Paul Taconet 
    affiliation: IRD
address:
  - code: IRD
    address: Institut de Recherche pour le Développement (IRD), av. Jean Monnet, CS 30171, 34203 Sète cédex, France
  - code: MARBEC
    address: MARBEC, University of Montpellier, CNRS, Ifremer, IRD, Sète, France
# bibliography: ["IOTC-2022-WPDCS18.bib"] # Replace with one or more of your own bibtex files. Better BibTeX for Zotero is your friend
csl: dmk-format.csl # Use any CSL style. See https://www.zotero.org/styles for a good list. Ignored if citation_package: natbib
link-citations: TRUE
output:
  bookdown::pdf_document2:
    extra_dependencies: ["adjustbox", "subfig", "flafter"]
    toc: FALSE
    keep_tex: TRUE
    template: template.tex
    #md_extensions: "-autolink_bare_uris"
    number_sections: TRUE
    citation_package: default # Can also be "natbib"
  bookdown::word_document2: 
    # Produces largely readable output, though some cross-referencing may fail. Useful for collaboration.
    toc: TRUE
lang: en # Main document language in BCP47 format
geometry: "margin=25mm"
papersize: a4
#linestretch: 2 # for double spacing
endfloat: FALSE # Set to TRUE to turn on latex endfloat package to place figures and tables at end of document
# endfloatoption: # See endfloat documentation for more possibilities
#   - tablesfirst # Default
#   - nomarkers # Default
numberlines: FALSE
authblk: FALSE # FALSE = author affiliations in footnotes; TRUE = author affiliations in a block below author names
footnotehyper: FALSE # TRUE will give you enhanced table footnote capabilities. Set to FALSE to be able to use French blocks. Needed due to what appears to be a latex bug.
urlcolor: blue
linkcolor: blue
citecolor: blue
graphics: TRUE # Needed to be able to include images
tables: TRUE # Needed to be able to include tables
fancyhdr:
  first:
    headleft: "Global Tuna Atlas comparison between two datasets"
    headright: "GTA"
    headrulewidth: 0pt
    #footleft: A left foot
    footrulewidth: 0pt
  subsequent:
    headleft: "Global Tuna Atlas comparison between two datasets"
    headright: "GTA"
    headrulewidth: 1pt
    footrulewidth: 0pt
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  fig.align = 'center',
  error = TRUE
)
```

```{r namingplots, include=FALSE}
counter <- 1  # Initialize a counter

knitr::opts_hooks$set(plot = function(options) {
  if (!is.null(options$fig.cap)) {
    filename <- paste0(options$label, "_", counter, ".pdf")
    options$fig.path <- paste0("path/to/save/directory/", filename)
    counter <<- counter + 1  # Increment the counter
  }
  options
})
```


```{r utility_functions, include=FALSE}
`%notin%` <- Negate(`%in%`)

last_path = function(x) {
  substr(x, max(gregexpr("/", x)[[1]]) + 1, nchar(x))
}

last_path_reduced = function(x) {
  gsub("georef_dataset", "", last_path(x))
}

is_null_or_not_exist = function(x) {
  if (!exists(deparse(substitute(x))) || is.null(x)) {
    return(TRUE)
  } else {
    return(FALSE)
  }
}
```


```{r globalvariables, include=FALSE}

if(!exists("child")){child = FALSE} else{child = child}
if(!exists("step_title")){step_title_t_f = FALSE} else{step_title_t_f = TRUE}

if (exists("params")) {
  for (i in 1:length(params)) {
    if(!exists(paste0("parameter_", names(params)[i]))) {
      assign(paste0("parameter_", names(params)[i]), params[i][[1]])
    }
  }
}

if(!exists("fact") || is.null(fact)){fact <-  "effort"}

if(is_null_or_not_exist(parameter_short)){parameter_short <-  FALSE}
if(is_null_or_not_exist(columns_to_keep)){
  parameter_columns_to_keep <- c("Precision", "measurement_unit", "Values dataset 1",
                                 "Values dataset 2", "Loss / Gain",
                                 "Difference (in %)", "Dimension",
                                 "Difference in value")
} else {
  parameter_columns_to_keep <- columns_to_keep
}

if(is_null_or_not_exist(parameter_UNK_for_not_standards_unit)){
  parameter_UNK_for_not_standards_unit <- TRUE
}

if(is_null_or_not_exist(parameter_mapped)){parameter_mapped <- TRUE}

if(is_null_or_not_exist(parameter_filtering)){parameter_filtering <- list(species = NULL, fishing_fleet = NULL)}
if(is_null_or_not_exist(time_dimension)){time_dimension = c("time_start")}

if(is_null_or_not_exist(geographical_dimension)){geographical_dimension = "geographic_identifier"}



matchingList <- parameter_filtering %>% purrr::keep( ~ !is.null(.) )
```

```{r shapefilereading, include=FALSE, error=0}


shapefile.fix <- st_read("data/world_sf.csv") %>% dplyr::select(CWP_CODE, GRIDTYPE, SURFACE) %>% dplyr::rename(geom = geometry)


shape_without_geom  <- shapefile.fix %>% as_tibble() %>%dplyr::select(-geom)




continent <- st_read("data/continent.csv") %>% dplyr::rename(geom = geometry)






```


```{r speciesandgearfilereading, cache=FALSE}
species_group <-  read_csv("https://raw.githubusercontent.com/fdiwg/fdi-codelists/main/global/cl_asfis_species.csv") %>% janitor::clean_names() %>%  dplyr::select(species_group = taxa_order, species = code) 
 cl_cwp_gear_level2 <- read_csv(file.path("https://raw.githubusercontent.com/fdiwg/fdi-codelists/main/global/firms/gta/cl_isscfg_pilot_gear.csv")) %>% select(Code = code, Gear = label)
 
 
if(is_null_or_not_exist(parameter_colnames_to_keep)){colnames_to_keep <- c("fishing_fleet",         "gear_type",                 "time_start",                 
                      "geographic_identifier","fishing_mode",           "species",                       
                      "measurement_unit",                 "measurement_value",                "source_authority")
}else {colnames_to_keep <-parameter_colnames_to_keep}
 

if (is_null_or_not_exist(parameter_titre_dataset_1)){
  titre_1 <- last_path_reduced(as.character(parameter_init))
} else {
  titre_1 <- parameter_titre_dataset_1
}






```


```{r GTAMARKDOWNFUNCTIONS, include=FALSE}
fSpatPlan_Convert2PacificRobinson = function(df, buff = 0){
  
  if(!exists("df_robinson")){
    df_robinson <- df}
  return(df_robinson)
  
}

knit_child_map =function(list_map_unit){
  assign("unit_name_map", list_map_unit[2][[1]], envir = environment())
  assign("map_for_knit", list_map_unit[1][[1]], envir = environment())

  knit_child(text = c(
    '```{r results = "asis"}',
    '',
    'unit_title <- gsub("_","..",unit_name_map)',
    '```',
    '',
    '',
    '```{r results="asis", fig.cap = paste0("Map of the differences between two datasets for the unit ", unit_title)}',
'',
  'map_for_knit',
  '',
    '```',
  '',
  '',''),
  envir = environment(), quiet= TRUE)
}


qflextable2 =function(x, captionn = NULL, autonumm = autonum, pgwidth = 6, colour = FALSE){
 y<-x
 y <- y %>% dplyr::mutate_if(is.factor, as.character) %>% dplyr::mutate_if(is.character, ~str_replace_all( ., ",", ", \n" )) %>% 
  dplyr::mutate_if(is.character,~str_replace_all( ., "_", "-" )) %>% dplyr::mutate_if(is.numeric, function(.){round(.,2)})
  flextable <- flextable(y)
  if(colour){
  flextable <- flextable %>% 
          color(~ `Difference (in % of tons)` < 0, color = "green",~ `Difference (in % of tons)`) %>% 
          color(~ `Difference (in % of tons)` >0, color = "red",~ `Difference (in % of tons)`)%>%   color(~ `Difference (in % of fish)` < 0, color = "green",~ `Difference (in % of fish)`) %>% 
          color(~ `Difference (in % of fish)` >0, color = "red",~ `Difference (in % of fish)`)%>%color(~ `Difference (in % of lines)` < 0, color = "green",~ `Difference (in % of lines)`) %>% 
          color(~ `Difference (in % of lines)` >0, color = "red",~ `Difference (in % of lines)`)
  } 
  if(!is.null(captionn)){flextable_captionned <- set_caption(flextable, caption = captionn,  style = "Table Caption")} else {flextable_captionned <- flextable}
  ft_out <- flextable_captionned %>% autofit()
  ft_out <- width(ft_out, width = dim(ft_out)$widths*pgwidth /(flextable_dim(ft_out)$widths))

  return(ft_out)

}


filtering_function= function(dataframe_to_filter, colnames_to_filter, matchingList, geo_dim, parameter_fact, parameter_UNK_for_not_standards_unit){
  if(length(colnames_to_filter)!= 0){  dataframe_to_filter <- dataframe_to_filter%>% dplyr::filter(!! rlang::parse_expr(str_c(colnames_to_filter, matchingList, sep = '%in%', collapse="&")))}
  if(  parameter_UNK_for_not_standards_unit & parameter_fact == "effort"){
    dataframe_to_filter <- dataframe_to_filter %>% dplyr::mutate(measurement_unit = ifelse(measurement_unit%in%c("HOOKS","FDAYS"), measurement_unit, "UNK" ))}
  if("geographic_identifier"%in%colnames(dataframe_to_filter)){
    dataframe_to_filter <- dataframe_to_filter %>% dplyr::rename("geographic_identifier" := {{geo_dim}})
  }
  return(dataframe_to_filter)
}

tidying_data_for_GTA = function(dataframe, time_dim, shape, species_group_dataframe = species_group, cl_cwp_gear_level2_dataframe = cl_cwp_gear_level2){
  if("geographic_identifier"%in%colnames(dataframe)){
  dataframe <- dataframe%>%  dplyr::left_join(shape, by = c("geographic_identifier"="CWP_CODE"))
  print_map <- TRUE
  } else {print_map <- FALSE}


dataframe <- dataframe %>% mutate_at(all_of(time_dim), as.character)

if("GRIDTYPE"%in%colnames(dataframe)){
  dataframe <- dataframe%>%dplyr::mutate(GRIDTYPE = as.character(GRIDTYPE))
}

dataframe <- dataframe %>% dplyr::left_join(species_group_dataframe%>% dplyr::distinct(), by = c("species"))
    if("gear_type" %in%colnames(dataframe) ){
    dataframe <- dataframe %>% dplyr::left_join(cl_cwp_gear_level2_dataframe, by = c("gear_type" = "Code"))
    }

  
  dataframe <- dataframe%>%dplyr::mutate(measurement_unit = dplyr::case_when(measurement_unit %in% c("MT","t","MTNO", "Tons")~ "Tons", measurement_unit %in% c("NO", "NOMT","no", "Number of fish")~"Number of fish", TRUE ~ measurement_unit)) 

return(list(dataframe = dataframe, print_map = print_map))
}


fonction_groupement = function(these_col, init, final){
  
  # Compute sum of values for each combination of the columns in "these_col" and "measurement_unit" in the "init" dataframe
  groupement_1 <- init %>%
    dplyr::ungroup() %>%
    dplyr::group_by(!!!rlang::syms(these_col), measurement_unit) %>%
    dplyr::summarise(value_sum_1 = ((sum(measurement_value, na.rm=TRUE)))) %>%
    dplyr::ungroup() %>%
    dplyr::mutate(value_sum_1 = dplyr::coalesce(value_sum_1, 0)) %>%
    dplyr::mutate(measurement_unit = as.character(measurement_unit)) %>%
    dplyr::mutate(number_lines1 = n())
  
  # Compute sum of values for each combination of the columns in "these_col" and "measurement_unit" in the "final" dataframe
  groupement_2 <- final %>%
    dplyr::ungroup() %>%
    dplyr::group_by(!!!rlang::syms(these_col), measurement_unit) %>%
    dplyr::summarise(value_sum_2 = ((sum(measurement_value, na.rm=TRUE)))) %>%
    dplyr::ungroup() %>%
    dplyr::mutate(value_sum_2 = dplyr::coalesce(value_sum_2, 0)) %>%
    dplyr::mutate(measurement_unit = as.character(measurement_unit)) %>%
    dplyr::mutate(number_lines2 = n())
  
  # Join the two dataframes based on the columns in "these_col" and "measurement_unit"
  fulljoin <- dplyr::full_join(groupement_1, groupement_2) %>%
    dplyr::mutate(value_sum_2 = dplyr::coalesce(value_sum_2, 0)) %>%
    dplyr::mutate(value_sum_1 = dplyr::coalesce(value_sum_1, 0)) %>%
    dplyr::mutate(loss = value_sum_1 - value_sum_2) %>%
    # Compute whether the difference in value is a gain or loss
    dplyr::mutate(`Loss / Gain` = dplyr::case_when(abs(loss) <= 1 ~ "Egal", loss > 1 ~"Loss",  loss < 1 ~"Gain")) %>%
    dplyr::mutate(Loss_pourcent = 100*((value_sum_1 - value_sum_2)/value_sum_1)) %>%
    dplyr::mutate(Dimension = colnames(groupement_1[1])) %>%
    dplyr::rename("Precision" = 1) %>%
    dplyr::mutate(Precision = as.character(Precision)) %>%
    dplyr::mutate(value_sum_2 = dplyr::coalesce(value_sum_2, 0)) %>%
    # Set Loss_pourcent to 100 if it is NA or -Inf
    dplyr::mutate(Loss_pourcent = base::ifelse(is.na(Loss_pourcent)|Loss_pourcent==-Inf, 100, Loss_pourcent)) %>%
    dplyr::ungroup() %>%
    # Compute the difference in the number of lines between the two dataframes
    dplyr::mutate(loss_nb_ligne = number_lines1 - number_lines2) %>%
    dplyr::mutate(`Difference in value`= (value_sum_2 - value_sum_1)) %>% #final - init
    dplyr::rename(`Difference (in %)` = Loss_pourcent,`Difference in number of lines` = loss_nb_ligne)%>%
    dplyr::mutate_if(is.numeric, list(~replace_na(., 0)))

return(fulljoin)
}


resume_knit_child = function(x){
  
  knitr::knit_child(text = c(
    '',
    '```{r}', 
    'dimension_title <- gsub("_","..",x$dimension)',
    '',
    '```',
    '',
    '',
    '',
    '```{r results = "asis" ,fig.cap = paste0("Distribution in value for the dimension : ",(dimension_title))}',
    '',
    'x$pie_chart',
    '```',
    '',
    '',
    '',
    '```{r results = "asis", eval= !is.null(x$df)}',
    'x$df',
    '',
    '',
    '```',
    '',
    '', 
    ''




  ), envir = environment(), quiet= TRUE)
}
function_pie_chart_df = function(dimension, ...){
  formals(pie_chart_2_default)$dimension <- dimension
  dimension_returned <- dimension
  pie_chart = pie_chart_2_default(...)
  if(exists("pie_chart$df")){
    df = pie_chart$df
  pie_chart = pie_chart$plot} else{
    pie_chart = pie_chart
    df = NULL}

if(!is.null(df)){
df <- qflextable2(df, captionn = paste0("Strata movement for the dimension : ", dimension_returned))}
  return(list(pie_chart=pie_chart,df=df, dimension=dimension_returned))
}


function_knitting = function(x){
assign("Dimension2", gsub("_", "", unique(x$data$Dimension)), envir = environment())
assign("y", x, envir = environment())
title_knit <- paste0("Evolutions of values for the dimension ", Dimension2, " for ", `titre_1`, " and ",`titre_2`, " dataset ")
if(nrow(final)==0){title_knit = paste0("Evolutions of values for the dimension ", Dimension2, " for ", `titre_1`, " dataset ")}
knitr::knit_child(text =c('```{r fig.cap=`title_knit`, fig.align = "center", out.widht = "100%"}',
'',
'',
'(y)',
'',
'```'), envir = environment(), quiet= TRUE)
}
function_knitting_difference = function(x){
assign("Dimension2", gsub("_", "", unique(x$data$Dimension)), envir = environment())
assign("y", x, envir = environment())
knitr::knit_child(text =c('```{r fig.cap=paste0("Differences in percent of value for temporal dimension :  ", Dimension2, " between ", `titre_1`, " and ",`titre_2`, " dataset ")}',
'',
'',
'(y)',
'',
'```'), envir = environment(), quiet= TRUE)
}


```

```{r options, include=FALSE}
base::options(scipen=999)
plotting_type <- "plot" 
if (knitr::is_html_output()){plotting_type <- "view" }
```



```{r childheader, include=FALSE}

if(!exists("child_header")){child_header = "#"}
cat2 = function(x){cat(paste0(child_header, x, " \n"))}

if(!child|!step_title_t_f){
  cat2 <- cat

}

if(step_title_t_f){
  cat2(step_title)
}

if(!child){cat("\\clearpage")}

```


```{r libraries, eval = !child, message=FALSE, warning=FALSE, include=FALSE}

# Set custom inline hook to format numeric values
knitr::knit_hooks$set(inline = function(x) {   
  if(!is.numeric(x)){
    x
  } else {
    prettyNum(round(x,2), big.mark=",")
  }
})

# Prevent package installation from upgrading
formals(install.packages)$upgrade <- "never"

# List of required packages
required_packages <- c("dplyr", "knitr", "stringr", "purrr", "readxl", "base", "flextable", "remotes", 
                        "utils", "DBI", "odbc", "rlang", "sf", "kableExtra", "readr", "tidyr", "ggplot2", 
                        "stats", "RColorBrewer", "cowplot", "tmap", "RPostgreSQL", "officer", "gdata")

# Check if each package is already installed, and if not, install and load it
for (package in required_packages) {
  if (!require(package, character.only = TRUE)) {
    install.packages(package)
    require(package)
  }
}

# Install and load sutdycatchesird package from GitHub if not already installed
if(!require(sutdycatchesird)){
  remotes::install_github("BastienIRD/sutdycatchesird")
  require(sutdycatchesird)
}

```

```{r include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE, error = TRUE
)
knitr::opts_chunk$set(fig.filename = paste0("figure_", knitr::opts_current$get("fig.cap"), ".png"), fig.path = fig.path)

knitr::knit_hooks$set(fig_filename = function(before, options, envir) {
  if (before && !is.null(options$fig.cap)) {
    options$fig.filename <- paste0("figure_", gsub(" ", "_", options$fig.cap), ".png")
  }
  NULL
})

# Custom hook for kable
knitr::knit_hooks$set(kable = function(before, options, envir) {
  if (before && !is.null(options$fig.cap)) {
    filename <- paste0(options$fig.cap, ".html")
    save_as_html(kable_table, filename)
  }
  NULL
})

# Custom hook for qflextable
knitr::knit_hooks$set(qflextable = function(before, options, envir) {
  if (before && !is.null(options$fig.cap)) {
    filename <- paste0(options$fig.cap, ".docx")
    save_as_docx(qflextable_table, filename)
  }
  NULL
})

# Custom hook for ggplot
knitr::knit_hooks$set(ggplot = function(before, options, envir) {
  if (before && !is.null(options$fig.cap)) {
    filename_pdf <- paste0(options$fig.cap, ".pdf")
    filename_png <- paste0(options$fig.cap, ".png")
    filename_html <- paste0(options$fig.cap, ".html")

    ggsave(filename_pdf, plot = ggplot_object, device = "pdf")
    ggsave(filename_png, plot = ggplot_object, device = "png")
    webshot::webshot(ggplot_object, file = filename_html)
  }
  NULL
})


options(knitr.duplicate.label = "allow")
```



```{r eval = !child, message=FALSE, warning=FALSE, include=FALSE}
set_flextable_defaults(
  font.size = 10,
  font.color = "black",
  digits = 2,
  theme_fun = "theme_box"
)


#set the dataset caption styling
# knitr::opts_chunk$set(tab.cap.pre = "Table ", tab.cap.sep = ": ")

#set the dataset caption styling
if(!child){autonum <- officer::run_autonum(seq_id = "tab", bkm = "TC1", bkm_all = TRUE) # number the table, bkm (bookmark) is important as the cross-referencing is done using the bookmark
}

```


```{r filterprinting, eval=!child, results='asis'}

isNullList = function(x) all(!lengths(x))
if (isNullList(parameter_filtering)){cat("There are no filter on this data")} else {
  
  cat (paste0("The filter used on this data are:  \n "))
  for (i in 1:length(parameter_filtering)){
    if (parameter_filtering[i] %in% parameter_filtering & !is.null(parameter_filtering[[i]])){
      cat(paste0("***- On ", names((parameter_filtering)[i]), " : ", paste((parameter_filtering)[[i]], collapse = " ; "),"*** \n"))
    } else {""}
  }
}

```






```{r filereading}
init <- readRDS(paste0(as.character(parameter_init),"/rds.rds"))
if(is_null_or_not_exist(parameter_final)){
  final <- init[0,] 
 unique_analyse <-  TRUE
 } else{
final <- readRDS(paste0(as.character(parameter_final),"/rds.rds"))
unique_analyse <- FALSE
 }


if (is_null_or_not_exist(parameter_titre_dataset_2) & !unique_analyse){
  titre_2 <- last_path_reduced(as.character(parameter_final))
  } else if (unique_analyse) {
  titre_2 <- "NONE"
} else {
    titre_2 <- parameter_titre_dataset_2
}

titre_2 <- gsub("_","-",titre_2)
titre_1 <- gsub("_","-",titre_1)

```


```{r mappingifnot, include=FALSE, eval=FALSE}


if(!parameter_mapped){
  


mapping_dataset <- read.csv(paste0("data/codelist_mapping_rfmos_to_global.csv"), stringsAsFactors = F,colClasses = "character")#, entity$data$source[[2]])) #bof mais pour l'instant comme ça 
  mapping_keep_src_code <- FALSE

  source("https://raw.githubusercontent.com/eblondel/geoflow-tunaatlas/master/tunaatlas_scripts/generation/map_codelists.R")
  init <- map_codelists(con = con, fact = parameter_fact, mapping_dataset = mapping_dataset, dataset_to_map = init, mapping_keep_src_code = FALSE, summary_mapping = FALSE)$dataset_mapped
  #this map condelist function is to retrieve the mapping dataset used
  # final <- map_codelists(conn, parameter_fact, mapping_dataset, final, mapping_keep_src_code = FALSE, summary_mapping = FALSE)
}
```

```{r filetidying}

final <- final %>% dplyr::select(any_of(colnames_to_keep))
init <- init %>% dplyr::select(any_of(colnames_to_keep))


list_return_init <- tidying_data_for_GTA(init,time_dim = time_dimension, shape = shape_without_geom)
init <- list_return_init$dataframe
final <- tidying_data_for_GTA(final, time_dim = time_dimension, shape = shape_without_geom)$dataframe

if(exists("print_map") | is.null(print_map)){
print_map <- list_return_init$print_map
} else {print_map <- print_map}

if(exists("print_map") | is.null(print_map)){
print_map<- TRUE}

```






```{r explanationongainandloss, results='asis', eval=(!parameter_short && !unique_analyse)}

knit_child_attention <- knitr::knit_child(text =c(
  '',
      '```{r results="asis"}', 
  'test <- 1', 
  '',
  '```',
  '',
  '*Attention ! In the following document :* \n ',
  '-***All the differences inferior to 0 corresponds to gain in captures.***', 
  '\n',
  '-***The initial dataset, refered as, dataset 1 is `r titre_1`***',
  '\n',
'-***The final dataset, refered as, dataset 2 is `r titre_2`***', 
  '\n',
'', 
''), envir = environment(), quiet= TRUE)

cat(knit_child_attention)
```

```{r explanationonresultmapping, results='asis', eval=(!parameter_mapped &&  !unique_analyse) }
knit_mapped <- knitr::knit_child(text =c(
  '',
      '```{r results="asis"}', 
  '',
  '```',
  '',
  'In this comparison, the differences due to the mapping thas is to say, the renaming of codes to harmonize data will not be presented. The recap of the mapping is presented in annexe.',

'', 
''), envir = environment(), quiet= TRUE)

cat(knit_mapped)
```


```{r filteringfunctionondata}


colnames_to_filter <- colnames(init %>% select(names(matchingList)))

names(matchingList) <- colnames_to_filter

matchingList <- lapply(matchingList, function(x){ #handling single filter
  if(length(x) == 1){
  x <- c(x, x) }else {
    x
  }

}
  )


formals(filtering_function)$geo_dim = geographical_dimension
formals(filtering_function)$parameter_fact = parameter_fact
formals(filtering_function)$parameter_UNK_for_not_standards_unit = parameter_UNK_for_not_standards_unit

init <- filtering_function(dataframe_to_filter = init, colnames_to_filter = colnames_to_filter, matchingList = matchingList)

if(unique_analyse){final <- init[0,]} else {final <- filtering_function(final, colnames_to_filter = colnames_to_filter, matchingList = matchingList)}



```






```{r firstfonctiongroupement, message=FALSE, warning=FALSE, include=FALSE, cache=FALSE}



carte_init <- fonction_groupement("species",init, final)

Dimensions <- colnames(init)[colnames(init) != "measurement_unit" & colnames(init)!= "measurement_value"& colnames(init)!= "SURFACE"]
t <- carte_init[0,]


```



```{r allfonctiongroupement,  message=FALSE, warning=FALSE, include=FALSE}
for (i in Dimensions){
  temporaire <- fonction_groupement(i,init, final)
  assign(paste0("test", i), temporaire)
  
  t <- rbind(t, temporaire)
}

```


```{r stratasloss, eval=!unique_analyse, message=FALSE, warning=FALSE, include=FALSE}

nb_ligne_init_millions <- nrow(init)
nb_ligne_final_millions<- nrow(final)
# 
sum_valeur_init <- sum(init$measurement_value, na.rm = TRUE)
sum_valeur_final <- sum(final$measurement_value, na.rm = TRUE)

t$Dimension <-as.character(t$Dimension)
t$Precision <-as.character(t$Precision)

strates_perdues <- t %>%dplyr::filter(value_sum_2 == 0 & `Loss / Gain` == "Loss")
strates_gagnees <- t %>%dplyr::filter(value_sum_1 == 0 & `Loss / Gain` == "Gain")
nombre_strates_perdues <- nrow(strates_perdues)
nombre_strates_gagnees <- nrow(strates_gagnees)
nombres_de_strates_totales <- nrow(t)
pourcentage_strates_perdues <- 100-(100*((nombres_de_strates_totales-nombre_strates_perdues)/nombres_de_strates_totales))
rm(init_no, init_t, final_no, final_t)
gc()

strates_perdues_first_10 <- rbind(strates_perdues,strates_gagnees) %>%dplyr::filter(`Loss / Gain` != 'Egal')%>%ungroup %>%dplyr::filter(Dimension!="geographic_identifier") %>%dplyr::group_by(`Loss / Gain`,Dimension,measurement_unit)%>%# slice(1:10) %>%
  dplyr::select(Dimension, everything())

if (nrow(strates_perdues_first_10)== 0){strates_perdues_first_10 <- rbind(strates_perdues,strates_gagnees) %>%dplyr::filter(`Loss / Gain` != 'Egal')%>%ungroup %>%dplyr::filter(Dimension!="geographic_identifier") %>%dplyr::group_by(`Loss / Gain`,Dimension,measurement_unit)%>% #slice(1:10) %>%
  dplyr::select(Dimension, everything()) }

strates_perdues_first_10[strates_perdues_first_10==""] <- "NA"
strates_perdues_first_10[is.na(strates_perdues_first_10)] <- "NA"

```

```{r eval=!unique_analyse , results='asis'}
if (round(sum_valeur_init) == round(sum_valeur_final)&nrow(t %>%dplyr::filter(`Loss / Gain` != 'Egal'))==0){
  cat("There are no differences between the two datasets, this step is not changing the data in any way")
  
  knitr::knit_exit(fully = FALSE)}
```

```{r eval=!unique_analyse ,  results='asis'}
if(parameter_short == FALSE){cat2("# Main differences \n ")}
```


```{r summaryofdifferences, eval=!unique_analyse}

units <- unique(c(unique(init$measurement_unit), unique(final$measurement_unit)))
list_units <- unlist(as.vector(lapply(units, function(.)paste0("Value in ", .))))
df <- data.frame(matrix(ncol =4, nrow = length(c(c( "Lines"), list_units ))))
init_group <- init %>% dplyr::group_by(measurement_unit) %>% dplyr::summarise(titre_test1 = sum(measurement_value)) 
final_group <- final %>% dplyr::group_by(measurement_unit) %>% dplyr::summarise(titre_test2 = sum(measurement_value)) 
nrowinit <- nrow(init)
nrowfinal <- nrow(final)
join <- dplyr::full_join(init_group, final_group) %>% mutate(across(where(is.numeric), ~replace(., is.na(.), 0))) %>% dplyr::arrange(measurement_unit) %>%dplyr::rowwise() %>%  dplyr::mutate(measurement_unit = paste0(measurement_unit)) %>% dplyr::mutate(Difference = -titre_test1 + titre_test2)%>%mutate("Difference (in %)" = 100*(Difference /titre_test1)) %>%  dplyr::rename(!!as.symbol(eval(parse(text = "titre_1"))) := titre_test1)%>% dplyr::rename(!!as.symbol(eval(parse(text = "titre_2"))) := titre_test2)


join <- qflextable(join%>% dplyr::mutate_if(is.numeric, function(.){round(.,2)})%>% dplyr::mutate(Difference= round(Difference)))%>% 
          color(~ `Difference` > 0, color = "green",~ `Difference`) %>% 
          color(~ `Difference` < 0, color = "red",~ `Difference`) %>% autofit()
join <- width(join, width = dim(join)$widths*6 /(flextable_dim(join)$widths))

join <- set_caption(join, "Summary of the difference between the two datasets")



```


```{r eval=!unique_analyse,echo=FALSE, results='asis', out.width="100%"}

join

```


```{r echo=FALSE, eval=!unique_analyse, message=FALSE, warning=FALSE, paged.print=TRUE, results='asis'}

strates_perdues_first_10 <- strates_perdues_first_10 %>% filter(Dimension %notin% geographical_dimension) %>% filter(Dimension %notin% time_dimension)

if (nrow(strates_perdues_first_10)!=0){


groupe_df <- flextable::as_grouped_data(strates_perdues_first_10 %>%dplyr::mutate(`Loss / Gain` = dplyr::case_when(loss > 1~ "Loss", abs(loss)<=1 ~ "No differences", loss < 1~ "Gain", TRUE ~ NA_character_))  %>% dplyr::mutate(`Loss / Gain` = dplyr::case_when(is.na(`Loss / Gain`) ~ "Gain",value_sum_1 == value_sum_2~"Egal", TRUE ~ `Loss / Gain`))%>% dplyr::ungroup()%>%  dplyr::rename(`Values dataset 1` = "value_sum_1",`Values dataset 2` = "value_sum_2") %>% dplyr::select(parameter_columns_to_keep) %>%  dplyr::group_by(Dimension, measurement_unit,`Loss / Gain`) %>% dplyr::arrange( Dimension, measurement_unit,`Loss / Gain`,desc(`Difference in value`)) %>% ungroup(),groups = c("Dimension","measurement_unit","Loss / Gain"))
  cat("The stratas differences (completely lost or appearing) between the first one and the second one are:\n")
  cat(knit_print(qflextable2(groupe_df%>% dplyr::select(Dimension, measurement_unit, `Loss / Gain`, Precision, `Difference in millions` = `Difference in value`), captionn = paste0("Disappearing or appearing stratas between ", titre_1, " and ", titre_2))))
  cat(paste0("They represent ", round(pourcentage_strates_perdues)," % of the total number of stratas."))
} else {towrite =("No strata is gain nor lost")}

```

```{r eval=!unique_analyse}

number_init_column <- as.data.frame(t(init %>% select(-measurement_value) %>% summarise_all(list(~n_distinct(.))))) %>%  dplyr::rename(!!as.symbol(eval(parse(text = "titre_1"))) := V1)
number_final_column <- as.data.frame(t(final %>% select(-measurement_value) %>% summarise_all(list(~n_distinct(.)))))%>%  dplyr::rename(!!as.symbol(eval(parse(text = "titre_2"))) := V1)

number_final_column<-number_final_column[order(row.names(number_final_column)), ,drop=F]
number_init_column<-number_init_column[order(row.names(number_init_column)), ,drop=F]


s <- cbind(number_init_column , number_final_column ) %>% mutate_all(as.numeric)
s$Difference <- s[,2]-s[,1]

rownames(s) <- paste0("Number of ", rownames(s))

```




```{r eval=!unique_analyse}

if(!(require(tibble))){ 
  install.packages("tibble") 
  (require(tibble))} 
qflextable2(s %>% tibble::rownames_to_column(" "), captionn = "Comparison of number of stratas between the two datasets")

```


```{r eval=parameter_short, results='asis'}

exit <- "This document only presents the summary of the differences between the two datasets. If you need a more detailed summary please provide FALSE as argument for the 'short' parameter"
if(child){exit <- ""}
if (parameter_short){knitr::knit_exit(exit, fully = FALSE)}


```


```{r eval= !unique_analyse,results='asis'}
title_introduction <- "# Introduction to the two datasets"
if(!unique_analyse){
  cat2(title_introduction)
  }

```

We first present the main characteristics of each dimension.

```{r results='asis'}
cat2("## Time coverage")
```

We present the evolution of value in every unit available (id est `r unique(init$measurement_unit)` )

```{r include=FALSE}
time_dimension_list_groupped <- lapply(time_dimension, fonction_groupement, init = init, final = final)

time_dimension_list_groupped_diff <- lapply(time_dimension_list_groupped, function(x){x %>%dplyr::mutate(Time = as.Date(Precision))%>%  dplyr::rename(`Values dataset 1` = "value_sum_1",`Values dataset 2` = "value_sum_2")%>% pivot_longer(cols = c(`Values dataset 1`, `Values dataset 2`), names_to = "Dataset", values_to ="Values") %>%dplyr::mutate(Dataset = dplyr::case_when(Dataset == "Values dataset 1" ~ titre_1 , TRUE ~ titre_2)) %>% dplyr::distinct()})
```


```{r}

if(unique_analyse){
  time_dimension_list_groupped_diff <- lapply(time_dimension_list_groupped_diff, function(x){x %>% filter(Values!=0)})
}

map <- lapply(time_dimension_list_groupped_diff, function(x){ggplot(x) +
aes(
x = Time,
y = Values,
fill = Dataset,
colour = Dataset,
group = Dataset
) +
geom_line(size = 0.5) +
scale_fill_hue(direction = 1) +
scale_color_hue(direction = 1) +
theme_dark() +
theme(legend.position = "top") +
facet_wrap(vars(measurement_unit), nrow = 2L)+
labs(x = unique(x$Dimension), y = "Values")+
facet_grid("measurement_unit", scales = "free_y")})

```


```{r}

map_unit_knit_list <- lapply(map, FUN = function_knitting)
```

```{r results='asis'}
cat(unlist(map_unit_knit_list), sep = "\n")
```


```{r}

time_dimension_list_groupped_diff_cumulated <- lapply(time_dimension_list_groupped_diff, 
                                                      function(x){
x <- x %>%dplyr::mutate(Time = as.Date(Precision))%>% arrange(Precision) %>%dplyr::group_by(measurement_unit, Dataset) %>% dplyr::mutate(`Cumulated values` = cumsum(`Values`)) %>% dplyr::distinct()
})

time_dimension_list_groupped_diff_cumulated <- lapply(time_dimension_list_groupped_diff_cumulated, function(x){
ggplot(x) +
    aes(
      x = Time,
      y = `Cumulated values`,
      colour = Dataset
    ) +
    geom_line(size = 0.5) +
    scale_color_hue(direction = 1) +
    theme_minimal() +
    facet_wrap(vars(measurement_unit), scales = "free", ncol = 2) +
    labs(x = unique(x$Dimension))+guides(fill=guide_legend(title="Dataset"))
  })

map_measurement_unit_knit_list_cumulated <- lapply(time_dimension_list_groupped_diff_cumulated, FUN = function_knitting)
```

```{r results='asis'}
cat(unlist(map_unit_knit_list_cumulated), sep = "\n")
```

```{r fig.cap=paste0("Cumulated ", parameter_fact, " evolution by unit for ", `titre_1`, " and ", `titre_2` , " dataset"), eval=FALSE}
ggplot_capt_time
```


```{r functionprintingmaps, eval =print_map}
fonction_empreinte_spatiale = function(variable_affichee){
  selection = function(x){x %>% dplyr::ungroup() %>% dplyr::select(geographic_identifier, measurement_value, GRIDTYPE, measurement_unit)}
  Initial_dataframe <-selection(init)
  Final_dataframe <-selection(final)
  geo_data <- gdata::combine(`Initial_dataframe`, `Final_dataframe`)
  rm(`Initial_dataframe`, `Final_dataframe`)
  gc()
  geo_data <- geo_data %>% dplyr::mutate(source = dplyr::case_when(source == "Initial_dataframe"~  eval(parse(text = "titre_1")),source == "Final_dataframe"~ eval(parse(text = "titre_2")), TRUE ~ "Error"))
  inner_join <- st_as_sf(geo_data%>% dplyr::group_by(geographic_identifier, measurement_unit,source)  %>%  dplyr::summarise(measurement_value = sum(measurement_value, na.rm = TRUE))  %>% dplyr::filter(measurement_value != 0) %>% dplyr::inner_join(shapefile.fix, by = c("geographic_identifier"="CWP_CODE")))
  
  if(nrow(inner_join %>% dplyr::filter(measurement_unit == variable_affichee)) != 0){
     if (plotting_type == "view"){image <- tm_shape(inner_join %>% dplyr::filter(measurement_unit == variable_affichee))+
      tm_fill("measurement_value", palette="RdYlGn", style="cont", n=8,
              id="name", midpoint = 0) +
      tm_layout(legend.outside = FALSE) + tm_facets(by=c("GRIDTYPE","source"), free.scales = TRUE)} else {image <- tm_shape(inner_join %>% dplyr::filter(measurement_unit == variable_affichee))+
        tm_fill("measurement_value", palette="RdYlGn", style="cont", n=8,
                id="name", midpoint = 0) +
        tm_layout(legend.outside = FALSE) + tm_facets(by=c("GRIDTYPE","source"), free.scales = TRUE)+tm_shape(continent)+tm_borders()}
    
    return(list(image, variable_affichee))
  }
}

map_unit_knit = function(map){
  # if (deparse(substitute(measurement_unit)) == "X[[i]]"){ #for sapply function bug
  # assign("r", measurement_unit, envir = environment())
  # }else {  assign("r", substitute(measurement_unit), envir = environment())}
  assign("unit_name_map", map[2][[1]], envir = environment())
  assign("map_for_knit", map[1][[1]], envir = environment())
  knitr::knit_child(text = c(
    '',
    '',
    '```{r}', 
    'dimension_title <- gsub("_","..",unit_name_map)',
    '```',
    '',
    '```{r,fig.cap = paste0("Distribution in value for the unit : ",(unit_name_map)), out.width = "100%"}',
    '',
    'map_for_knit',
    '```',
    '',
    ''
 ), envir = environment(), quiet= TRUE)
    }
```


```{r eval=print_map}

map_unit <- lapply(unique(t$measurement_unit), FUN = fonction_empreinte_spatiale)


```



\clearpage

```{r eval=print_map,results='asis'}
cat2("## Spatial coverage ")
```


```{r eval=print_map,results='asis'}
tmap_mode(plotting_type)

number_of_GRIDTYPE <- length(unique(testGRIDTYPE$Precision))
GRIDTYPE <- paste(as.list(unique(testGRIDTYPE$Precision)), collapse = " ; ")

```

```{r eval=print_map,results='asis'}

knit_child_map_printing <- knitr::knit_child(text =c(
    '',
  '```{r results="asis"}', 
  '',
  '```',
  '',
  'We represent spatial coverage, faceted by geographical category. The geographical category depends on the area of the geographic polygon. In this case there are `r number_of_GRIDTYPE` categories which are `r GRIDTYPE`. The category is made on the area, also different shapes could be included in the same geographical category (example 5x10, 10x5 and 25x2).', 
   '\n',
  ''

  ), envir = environment(), quiet= TRUE)


```



```{r eval=print_map,results='asis'}
cat(knit_child_map_printing)
```

```{r echo=FALSE, eval=print_map,results='asis'} 
map_unit_knit_list <- lapply(map_unit, FUN = map_unit_knit )
```


```{r printingmaps, eval = FALSE, echo=FALSE, eval=print_map,results='asis'}

cat(unlist(map_unit_knit_list), sep = "\n")

```

\clearpage


```{r results='asis'}

cat2("## Repartition of the data for the other dimensions")

```

We check the distribution of the value of each dimension and each unit.

```{r }
pie_chart_2_default <- studycatchesird::pie_chart_2
formals(pie_chart_2_default)$titre_1 <- titre_1
formals(pie_chart_2_default)$titre_2 <- titre_2
# formals(pie_chart_2_default)$first <- init
# formals(pie_chart_2_default)$second <- final
# if ("Gear"%in% colnames(init) & "Gear"%in% colnames(final) ){
  # list_pie_chart <- list("fishing_fleet","source_authority","Gear")} else {

list_pie_chart <- list(setdiff(colnames_to_keep, unlist(list(time_dimension, geographical_dimension, "measurement_unit", "measurement_value", "time_end"))))[[1]]
    
if(unique_analyse){
  formals(pie_chart_2_default)$titre_1 <- ""
}


```








```{r}

if(!unique_analyse){pie_charts_multiple <- lapply(list_pie_chart,FUN = function_pie_chart_df, first= init, second = final, topn = 5)}else{pie_charts_multiple <- lapply(list_pie_chart,FUN = function_pie_chart_df, first= init, topn = 5, title_yes_no = FALSE )}

```

```{r eval=unique_analyse}

figures<- lapply(pie_charts_multiple, function(x){x$pie_chart})

dimension_title_subfigures <- lapply(pie_charts_multiple, function(x){paste0("Distribution in value for the dimension : ", x$dimension)})

```


```{r }

if(is_null_or_not_exist("dimension_title_subfigures")){

  dimension_title_subfigures <- c("NULL","NULL")
  }


```

```{r eval=unique_analyse, echo=FALSE,  fig.cap='Other dimensions', fig.subcap=c(unlist(gsub("_","..",dimension_title_subfigures))), fig.ncol = 2, out.width = "50%", fig.align = "center"}

for (i in figures){plot(i)}

```


```{r eval=unique_analyse}
knitr::knit_exit(fully = FALSE)
```




```{r eval=!unique_analyse}

pie_chart_knit <- lapply(pie_charts_multiple, FUN = resume_knit_child)

```

```{r eval=!unique_analyse, results='asis'}
cat(unlist(pie_chart_knit),  sep = "\n")
```



\clearpage

```{r results='asis'}
cat2("# Differences between the two datasets")
```

```{r results='asis'}
cat2("## Differences in temporal data")
```

Here is represented the differences in percent for each year.

```{r}


map <- lapply(time_dimension, function(filtering_unit, dataframe){ggplot(dataframe%>% dplyr::filter(Dimension == filtering_unit)%>%dplyr::mutate(Time = as.Date(Precision))) +
aes(
x = Time,
y = `Difference (in %)`) +
geom_line(size = 0.5) +
scale_fill_hue(direction = 1) +
theme(legend.position = "top") +
facet_wrap(vars(measurement_unit), nrow = 2L)+theme_minimal()+
labs(x = filtering_unit)+
facet_grid("measurement_unit", scales = "free_y")}, dataframe = t)

```


```{r}



map_unit_knit_list <- lapply(map, FUN = function_knitting)
```

```{r results='asis'}
cat(unlist(map_unit_knit_list), sep = "\n")
```



\clearpage

```{r results='asis'}

cat2("## Differences in geographical data")

```


```{r eval=FALSE, include=FALSE, out.width="100%"}
tmap_mode(plotting_type)
formals(tm_shape)$drop.empty_facets <- FALSE

inner_join <- dplyr::inner_join(shapefile.fix,(t %>%dplyr::filter(Dimension == "geographic_identifier")) , by = c("CWP_CODE"="Precision"))%>%dplyr::mutate(`Impact on the data` = as.factor(dplyr::case_when(`Difference (in %)` == 0 ~ 'No differences', `Difference (in %)` == 100~'All data different',`Difference (in %)` < 0 ~ "Gain", TRUE ~ 'Loss')))

if (nrow(inner_join %>%dplyr::filter(`Impact on the data` == 'All data different'))!=0 & nrow(inner_join %>%dplyr::filter(`Impact on the data` == 'No differences'))!=0){
  if(plotting_type == "plot"){
    image <- tm_shape(dplyr::inner_join(shapefile.fix,(t %>%dplyr::filter(Dimension == "geographic_identifier")) , by = c("CWP_CODE"="Precision")) %>% dplyr::filter("Difference (in %)" != 100 & "Difference (in %)" != 0 )) +
      tm_fill("Difference (in %)", palette="RdYlGn", style="cont", n=8,
              id="name", midpoint = 0)+ tm_shape(inner_join %>%dplyr::filter(`Impact on the data` == 'No differences')) + tm_borders(col="skyblue")+tm_shape(inner_join %>%dplyr::filter(`Impact on the data` == 'All data different')) +tm_borders(col="red")+tm_facets(by = c("measurement_unit", "GRIDTYPE"),free.coords = FALSE, free.scales = FALSE)+
      tm_layout(legend.outside = TRUE)+tm_shape(continent)+tm_borders()} else {image <- tm_shape(dplyr::inner_join(shapefile.fix,(t %>%dplyr::filter(Dimension == "geographic_identifier")) , by = c("CWP_CODE"="Precision"))%>% dplyr::filter("Difference (in %)" != 100 & "Difference (in %)" != 0 )) +
        tm_fill("Difference (in %)", palette="RdYlGn", style="cont", n=8,
                id="name", midpoint = 0)+ tm_shape(inner_join %>%dplyr::filter(`Impact on the data` == 'No differences')) + tm_borders(col="skyblue")+tm_shape(inner_join %>%dplyr::filter(`Impact on the data` == 'All data different')) +tm_borders(col="red")+tm_facets(by = c("measurement_unit", "GRIDTYPE"),free.coords = FALSE, free.scales = FALSE)+
        tm_layout(legend.outside = TRUE)}
  #   tmap::tmap_save(image,"image2.png")
  # # mapshot(image, file = "image.png")
  # knitr::include_graphics("image2.png")
  image
} else{
  
  image <- tm_shape(dplyr::inner_join(shapefile.fix,(t %>%dplyr::filter(Dimension == "geographic_identifier")) , by = c("CWP_CODE"="Precision"))%>% dplyr::filter("Difference (in %)" != 100 & "Difference (in %)" != 0 )) +
    tm_fill("Difference (in %)", palette="RdYlGn", style="cont", n=8,
            id="name", midpoint = 0)+ tm_facets(by = c("measurement_unit", "GRIDTYPE"),free.coords = FALSE, free.scales = FALSE)+
    tm_layout(legend.outside = TRUE) +tm_shape(continent)+tm_borders()
  image
  #   tmap::tmap_save(image,"image3.png")
  # # mapshot(image, file = "image.png")
  # knitr::include_graphics("image3.png")
  
}
```



```{r eval=FALSE}

tmap_mode(plotting_type)
formals(tm_shape)$drop.empty_facets <- FALSE

inner_join <- dplyr::inner_join(shapefile.fix,(t %>%dplyr::filter(Dimension == "geographic_identifier")) , by = c("CWP_CODE"="Precision"))%>%dplyr::mutate(`Impact on the data` = as.factor(dplyr::case_when(`Difference (in %)` == 0 ~ 'No differences', `Difference (in %)` == 100~'All data different',`Difference (in %)` < 0 ~ "Gain", TRUE ~ 'Loss'))) 
minimum <- abs(min(t$`Difference (in %)`))
t_filtered <- dplyr::inner_join(shapefile.fix,(t %>%dplyr::filter(Dimension == "geographic_identifier")) , by = c("CWP_CODE"="Precision")) %>% dplyr::group_by(measurement_unit,GRIDTYPE) %>%  dplyr::mutate(`Difference (in %)` = log(`Difference (in %)` + abs(min(`Difference (in %)`)) +1)) %>% dplyr::filter(!(value_sum_1 ==0 & value_sum_2==0))
if (nrow(inner_join %>%dplyr::filter(`Impact on the data` == 'All data different'))!=0 & nrow(inner_join %>%dplyr::filter(`Impact on the data` == 'No differences'))!=0){
  if(plotting_type == "plot"){
    image <- tm_shape(t_filtered)  +
      tm_fill("Difference (in %)",style = "equal", palette = "Blues", auto.palette.mapping = FALSE, midpoint = 0)+tm_facets(by = c("measurement_unit", "GRIDTYPE"),free.coords = FALSE, free.scales = FALSE)+
      tm_layout(legend.outside = TRUE)+tm_shape(continent)+tm_borders()
    } else {
      image <- tm_shape(t_filtered) +
        tm_fill("Difference (in %)", palette="PiYG", style="cont", n=8,
                id="name", midpoint = 0)+tm_facets(by = c("measurement_unit", "GRIDTYPE"),free.coords = FALSE, free.scales = FALSE)+
        tm_layout(legend.outside = TRUE)}


} else{
  
  image <- tm_shape(t_filtered%>% dplyr::filter("Difference (in %)" != 100 & "Difference (in %)" != 0 )) +
    tm_polygons(col = "Difference (in %)", palette="PiYG", style="cont", n=8,
            id="name", midpoint = 0,interval.closure	= "left")+ tm_facets(by = c("measurement_unit", "GRIDTYPE"),free.coords = FALSE, free.scales = FALSE)+
    tm_layout(legend.outside = TRUE) +tm_shape(continent)+tm_borders()

}
```




Here is represented for each area the polygons keeping all the initial information, the ones losing a part and the ones losing all the information. 

```{r}
breaks <- dplyr::inner_join(shapefile.fix,(t %>%dplyr::filter(Dimension == "geographic_identifier")) , by = c("CWP_CODE"="Precision")) %>%dplyr::mutate(`Impact on the data` = dplyr::case_when(`Difference (in %)` == -Inf ~"Appearing data", -Inf<`Difference (in %)`  & `Difference (in %)`<= -100 ~"Gain (more than double)" ,  -100<`Difference (in %)`  & `Difference (in %)`<0 ~ "Gain",`Difference (in %)`==0~"No differences" ,0<`Difference (in %)`  & `Difference (in %)`<100 ~ "Loss",`Difference (in %)` ==100 ~  "All data lost" ))

breaks <- breaks %>% ungroup()


breaks$`Impact on the data` <- factor(breaks$`Impact on the data`, levels = c("Appearing data", "Gain (more than double)","Gain", "No differences", "Loss", "All data lost"))

 image <- tm_shape(breaks)+tm_fill("Impact on the data", palette="-PiYG",  id="name")+ tm_facets(by = c("measurement_unit", "GRIDTYPE"), free.scales = FALSE,free.coords = TRUE)+    tm_layout(legend.outside = TRUE)

if(plotting_type == "plot"){image <- image  +tm_shape(continent)+tm_borders()}

 

```




```{r results='asis', out.width="100%", fig.cap=paste0("Spatial differences between ", titre_1, " and ", titre_2, " dataset."), eval=print_map}


image


```



```{r eval=print_map}

init <- init%>% mutate(SURFACE=as.numeric(SURFACE))
spatial_coverage_init <-as.numeric(sum((init %>% dplyr::filter(measurement_value > 0)%>% select(geographic_identifier)%>%dplyr::distinct()%>%dplyr::left_join(shape_without_geom %>% dplyr::mutate(SURFACE=as.numeric(SURFACE)), by = c("geographic_identifier"="CWP_CODE")) %>% distinct())$SURFACE, na.rm = TRUE))


final <- final%>% mutate(measurement_value=as.numeric(measurement_value))
spatial_coverage_final <- as.numeric(sum((final %>% dplyr::filter(measurement_value > 0)%>% select(geographic_identifier)%>%dplyr::distinct() %>%dplyr::left_join(shape_without_geom%>% mutate(SURFACE=as.numeric(SURFACE)), by = c("geographic_identifier"="CWP_CODE")) %>% distinct)$SURFACE, na.rm = TRUE))
# if("try-error" %in% class(out)){knitr::knit_exit(paste0("nrow_final= ",nrow(final)))}

difference_coverage <- spatial_coverage_init - spatial_coverage_final / 1000000
gain_loss <- ifelse(difference_coverage >0, "Loss" ,"Gain")

```

The coverage difference is `r difference_coverage` km square. (`r gain_loss`)

\clearpage

```{r results='asis'}
cat2("## Loss and gain for each strata")
```

This section detail the differences that are observed between the dataframe ***`r titre_1`*** and ***`r titre_2`***.

```{r}
disappearing_strates <- t %>%dplyr::filter(value_sum_2 == 0)
```

```{r}

topn <- 6

```


```{r}

if(length(unique(init$species)) < 8){
topn <- (length(unique(init$species)))
}

```


```{r results='asis'}
cat2("## The differences for each dimension")
```


We will look for each dimension the `r topn` most important differences without presenting the stratas completely appearing or desappearing.

```{r eval!=unique_analyse}


unit <- t  %>% dplyr::filter(`Difference (in %)` %notin% c(0,100, -Inf) & (value_sum_1!=0 )& value_sum_2!=0 ) 


if(nrow(unit) != 0){
  
  unit <- unit%>%dplyr::mutate(`Loss / Gain` = base::ifelse(loss >= 0, "Loss", "Gain")) %>% dplyr::mutate(`Loss / Gain` = dplyr::case_when(is.na(`Loss / Gain`) ~ "Gain", value_sum_1 == value_sum_2 ~"Egal", TRUE ~ `Loss / Gain`))%>%dplyr::mutate(Dimension = as.factor(Dimension)) %>%  dplyr::group_by(Dimension, measurement_unit,`Loss / Gain`) %>% arrange(desc(`Difference (in %)`)) %>% dplyr::mutate(id = row_number())%>%  dplyr::mutate(Precision = as.factor(base::ifelse(id>(topn),paste0("Others"),paste0(as.character(Precision))))) %>% dplyr::ungroup() %>%dplyr::group_by(`Loss / Gain`,Dimension,Precision, measurement_unit) %>%dplyr::summarise(across(is.numeric, sum)) %>%dplyr::mutate(`Difference (in %)` = (`Difference in value`/value_sum_1)*100) %>%dplyr::select(-id, -number_lines2)%>%dplyr::group_by(`Loss / Gain`,Dimension,measurement_unit) %>%  arrange(Dimension,measurement_unit,desc(`Difference (in %)`)) %>% mutate(Other_column = ifelse(Precision == "Others", 1, 0)) 


t3 <- as_grouped_data(unit %>% dplyr::ungroup() %>% 
                      dplyr::rename(`Values dataset 1` = "value_sum_1",
                                    `Values dataset 2` = "value_sum_2") %>% 
                      dplyr::filter(`Loss / Gain` != "Egal") %>% 
                      dplyr::select(parameter_columns_to_keep, Other_column) %>% 
                      dplyr::mutate(across(c("Values dataset 1", "Values dataset 2", "Difference in value"),  ~ round(., digits = 0))) %>% 
                       dplyr::mutate_if(is.numeric, base::round, digits=2) %>% 
                      dplyr::group_by(Dimension, measurement_unit, `Loss / Gain`) %>% 
                      dplyr::arrange(Dimension, measurement_unit, `Loss / Gain`, Other_column, desc(abs(`Difference in value`))) %>% 
                      dplyr::select(-Other_column),
                    groups = c("Dimension", "measurement_unit", "Loss / Gain"))

} else {to_cat <- "There are no differences between stratas aside the appearing and disappearing ones"}

```

```{r paged.print=TRUE, results='asis'}



if(nrow(unit != 0)){qflextable2(t3, captionn = "Difference between stratas of the two datasets")} else{cat(to_cat)}

```

```{r numberstrataswithtoutmapping, eval=!parameter_mapped}

initnotmapped <- readRDS(paste0(as.character(parameter_init),"/rds.rds"))
finalnotmapped <- readRDS(paste0(as.character(parameter_final),"/rds.rds"))

initnotmapped <- initnotmapped %>% dplyr::select(any_of(colnames_to_keep))
finalnotmapped <- finalnotmapped %>% dplyr::select(any_of(colnames_to_keep))


number_init_column <- as.data.frame(t(initnotmapped %>% select(-measurement_value) %>% summarise_all(list(~n_distinct(.))))) %>%  dplyr::rename(!!as.symbol(eval(parse(text = "titre_1"))) := V1)
number_final_column <- as.data.frame(t(finalnotmapped %>% select(-measurement_value) %>% summarise_all(list(~n_distinct(.)))))%>%  dplyr::rename(!!as.symbol(eval(parse(text = "titre_2"))) := V1)

rm(initnotmapped)
rm(finalnotmapped)

s <- cbind(number_init_column , number_final_column ) %>% mutate_all(as.numeric)
s$Difference <- s[,2]-s[,1]

rownames(s) <- paste0("Number of ", rownames(s))

```

```{r eval=!unique_analyse && !parameter_mapped}
if(!(require(tibble))){ 
  install.packages("tibble") 
  (require(tibble))} 
qflextable2(s %>% tibble::rownames_to_column(" "), captionn = "Comparison of number of stratas between the two datasets with including the differences due to the mapping of codelist")
```


```{r eval=parameter_mapped || child}
knitr::knit_exit(fully = FALSE)
```


```{r eval=!parameter_mapped, results='asis'}
cat2("# Annexe")
```

```{r eval=!parameter_mapped}

df_mapping_final_this_dimension <- read_csv("data/mapping_codelist_summary.csv")
t <- df_mapping_final_this_dimension %>% select(-trg_codingsystem)%>%dplyr::group_by(across(everything())) %>%  dplyr::mutate(src_codingsystem = unlist(str_split(src_codingsystem, "_"))[1]) %>% dplyr::ungroup() 

i <-pivot_wider(t %>% dplyr::mutate(src_code = as.character(src_code)), names_from = source_authority,names_prefix = "Ancient name for ", values_from = "src_code", values_fn = list)  %>% dplyr::rename("New code" = trg_code) %>% dplyr::rename(Dimension = src_codingsystem)%>%
    relocate(Dimension)
t <- as_grouped_data(i, groups = c("Dimension")) %>% as.data.frame() %>% dplyr::ungroup()
s <- t %>% rowwise() %>% dplyr::mutate(Dimension = ifelse(is.na(Dimension), " ", Dimension)) %>% dplyr::ungroup() %>% as.data.frame() %>% dplyr::mutate(`New code` = ifelse(is.na(`New code`) &  (Dimension == " "), "UNK", `New code`))
s[is.na(s)] <- ""

write.xlsx(s, "outputs/datasets/replacement_code_mapping.xlsx")

```

```{r eval=!parameter_mapped}

qflextable2(readxl::read_excel("outputs/datasets/replacement_code_mapping.xlsx"))

```





```{r eval=FALSE}



fonction_empreinte_spatiale_diff  = function(measurement_unit, plotting_type, shapefile_fix_function, t_filtered, percent = FALSE){
  if (deparse(substitute(measurement_unit)) == "X[[i]]"){ #for sapply function bug
  assign("new_name", paste0("Difference in millions of ",measurement_unit), envir = globalenv())
    if(percent){assign("new_name", paste0("Difference (in %) of ", measurement_unit), envir = globalenv())}
    }else {  assign("new_name", paste0("Difference in millions of ", substitute(measurement_unit)), envir = globalenv())
    if(percent){assign("new_name", paste0("Difference (in %) of ", substitute(measurement_unit)), envir = globalenv())}
    }
  
  enquo_unit <- enquo(measurement_unit)
  dataset <- dplyr::inner_join(shapefile_fix_function,(t_filtered%>% dplyr::ungroup() %>%dplyr::filter(Dimension == ("geographic_identifier")) %>% dplyr::filter(measurement_unit == !!enquo_unit)) , by = c("CWP_CODE"= "Precision"))
  if(percent){
  dataset <- dataset%>%  dplyr::rename(!!as.symbol(eval(parse(text = "new_name"))) := "Difference (in %)")} else {
  dataset <- dataset%>%  dplyr::rename(!!as.symbol(eval(parse(text = "new_name"))) := "Difference in value")}
image_child <- tm_shape(dataset) +tm_fill(eval(parse(text = "new_name")), palette= ("-PiYG"), id= ("name"), midpoint = 0)+tm_facets(by =   c("GRIDTYPE", "Loss / Gain"),free.coords = FALSE)+tm_borders(lwd = 0.05)
  if(plotting_type == "plot"){image_child <-image_child+tm_shape(continent)+tm_borders()}
  return(list(image_child,measurement_unit))
}

tmap_mode(plotting_type)
formals(tm_shape)$drop.empty_facets <- FALSE
formals(fonction_empreinte_spatiale_diff)$plotting_type <- plotting_type
formals(fonction_empreinte_spatiale_diff)$shapefile_fix_function <- shapefile.fix
formals(fonction_empreinte_spatiale_diff)$t_filtered <- t_filtered
# t_filtered <- t

map_diff <- lapply(unique(t_filtered$measurement_unit), fonction_empreinte_spatiale_diff)
map_diff


map_plotted_knit <- lapply(map_diff, knit_child_map)
formals(fonction_empreinte_spatiale_diff)$percent <- TRUE
map_diff_percent <- lapply(unique(t_filtered$measurement_unit), fonction_empreinte_spatiale_diff)

map_plotted_percent <- lapply(map_diff_percent, knit_child_map)

```


```{r eval=FALSE}


inner_join <- dplyr::inner_join(shapefile.fix,(t %>%dplyr::filter(Dimension == "geographic_identifier")) , by = c("CWP_CODE"="Precision"))%>%dplyr::mutate(`Impact on the data` = as.factor(dplyr::case_when(`Difference (in %)` == 0 ~ 'No differences', `Difference (in %)` == 100~'All data different',`Difference (in %)` < 0 ~ "Gain", TRUE ~ 'Loss')))
t_filtered <- t #%>% dplyr::filter(`Difference (in %)` >= -100)
```




```{r eval=FALSE}

if (nrow(inner_join %>%dplyr::filter(`Impact on the data` == 'All data different'))!=0 & nrow(inner_join %>%dplyr::filter(`Impact on the data` == 'No differences'))!=0){
   try(restest <- lapply(unique(t_filtered$measurement_unit), FUN = knit_child_map))
}

formals(knit_child_map)$percent <- TRUE

if (nrow(inner_join %>%dplyr::filter(`Impact on the data` == 'All data different'))!=0 & nrow(inner_join %>%dplyr::filter(`Impact on the data` == 'No differences'))!=0){
   try(restest_percent <- lapply(unique(t_filtered$measurement_unit), FUN = knit_child_map))
}
```


```{r eval=FALSE,echo=FALSE, results='asis'}


try(cat(unlist(map_plotted_knit), sep = "\\clearpage"))


```

```{r eval=FALSE, echo=FALSE, results='asis'}


try(cat(unlist(map_plotted_percent), sep = "\\clearpage"))


```




```{r eval = FALSE, echo=FALSE, fig.cap=paste0("Geographical differences in % between ", titre_1, " and ", titre_2), results='asis'}


image



```
